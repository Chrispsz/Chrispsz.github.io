<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPLINKS V2</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root { --bg: #050505; --panel: #111; --border: #333; --text: #eee; --accent: #00e676; }
    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
    body { background: var(--bg); color: var(--text); font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; }
    
    /* LAYOUT */
    .app { max-width: 1000px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
    h1 { font-weight: normal; letter-spacing: -1px; color: var(--accent); }
    
    /* NAV */
    nav button { background: none; border: none; color: #666; cursor: pointer; padding: 5px 10px; font-family: inherit; text-transform: uppercase; font-weight: bold; }
    nav button.active { color: var(--text); border-bottom: 2px solid var(--accent); }

    /* UTILS */
    .hidden { display: none !important; }
    .w-full { width: 100%; }
    .mt-2 { margin-top: 10px; }
    .flex { display: flex; gap: 10px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    
    /* FORMS & INPUTS */
    input, textarea, select { 
      background: #000; border: 1px solid var(--border); color: var(--text); 
      padding: 8px; font-family: inherit; width: 100%; border-radius: 0; 
    }
    input:focus, textarea:focus { border-color: var(--accent); }
    textarea { min-height: 100px; resize: vertical; font-size: 11px; }

    /* BUTTONS */
    button.btn { 
      background: var(--panel); border: 1px solid var(--border); color: var(--text); 
      cursor: pointer; padding: 8px 15px; font-family: inherit; transition: 0.2s; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px;
    }
    button.btn:hover { border-color: var(--accent); color: var(--accent); }
    button.btn-primary { border-color: var(--accent); color: var(--accent); background: rgba(0, 230, 118, 0.1); }

    /* LISTS */
    .item { border-bottom: 1px solid var(--border); padding: 8px; display: flex; justify-content: space-between; align-items: center; }
    .item:hover { background: #0a0a0a; }
    .status { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .on { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
    .off { background: #333; }

    /* CHANNEL CARD */
    .ch-card { background: var(--panel); border: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; justify-content: space-between; height: 90px; }
    .ch-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; font-size: 12px; }
    .ch-meta { font-size: 10px; color: #666; margin-bottom: 8px; }
    .ch-actions { display: flex; gap: 5px; margin-top: auto; }
    .ch-actions button { flex: 1; font-size: 10px; padding: 4px; }

    /* MODAL */
    #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 100; display: none; align-items: center; justify-content: center; }
    #modal.open { display: flex; }
    .video-box { width: 100%; max-width: 900px; aspect-ratio: 16/9; background: #000; position: relative; border: 1px solid var(--border); }
    video { width: 100%; height: 100%; }
    .modal-controls { position: absolute; top: 10px; right: 10px; z-index: 10; background: rgba(0,0,0,0.5); padding: 5px; }
    
    /* TOAST */
    #toast { position: fixed; bottom: 20px; right: 20px; background: var(--panel); border: 1px solid var(--accent); padding: 10px 20px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200; }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>

<div class="app">
  <header>
    <h1>IPLINKS <span style="font-size:0.5em; color:#666; vertical-align:middle;">V2</span></h1>
    <nav>
      <button id="nav-config" class="active" onclick="App.go('config')">CONFIG</button>
      <button id="nav-list" onclick="App.go('list')">LIST</button>
    </nav>
  </header>

  <!-- CONFIG -->
  <div id="view-config">
    <div style="border: 1px dashed var(--border); padding: 10px; margin-bottom: 10px;">
        <label style="color:#666; font-size:11px; display:block; margin-bottom:5px;">INPUT RAW LOGS (SUZANOR FORMAT OK)</label>
        <textarea id="log" class="w-full" placeholder="Cole as mensagens aqui..."></textarea>
    </div>
    
    <div class="flex" style="align-items: flex-end;">
      <button class="btn btn-primary w-full" onclick="App.import()">EXTRACT & IMPORT</button>
    </div>
    
    <div class="mt-2">
      <div class="flex" style="margin-bottom: 10px;">
        <button class="btn" onclick="App.check()">CHECK STATUS</button>
        <button class="btn btn-primary" onclick="App.load()">LOAD CHANNELS</button>
      </div>
      <div id="accounts" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border);"></div>
    </div>

    <div class="mt-2" style="border-top: 1px dashed #333; padding-top: 10px;">
      <div style="font-size: 11px; color: #666; margin-bottom: 5px;">CLOUDFLARE KV (OPTIONAL)</div>
      <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 5px;">
        <input type="password" id="kv-t" placeholder="Token">
        <input type="text" id="kv-a" placeholder="Acc ID">
        <input type="text" id="kv-n" placeholder="NS ID">
      </div>
      <div class="flex">
        <button class="btn" onclick="App.sync()">SYNC KV</button>
        <button class="btn" onclick="App.download('m3u')">M3U</button>
        <button class="btn" onclick="App.download('json')">JSON</button>
        <button class="btn" onclick="App.clear()" style="color: red; border-color: red;">RESET</button>
      </div>
    </div>
  </div>

  <!-- LIST -->
  <div id="view-list" class="hidden">
    <div class="flex mb-2">
      <input type="text" id="search" placeholder="Filter..." onkeyup="App.render()" style="flex:1;">
      <select id="filter-q" onchange="App.render()" style="width: 100px;">
        <option value="all">ALL</option>
        <option value="hd">HD</option>
        <option value="sd">SD</option>
        <option value="4k">4K</option>
      </select>
    </div>
    <div id="grid" class="grid"></div>
  </div>
</div>

<!-- PLAYER -->
<div id="modal">
  <div class="video-box">
    <div class="modal-controls">
      <button class="btn" onclick="App.copy()">COPY URL</button>
      <button class="btn" onclick="App.close()">[X]</button>
    </div>
    <video id="v" controls autoplay></video>
  </div>
</div>

<div id="toast"></div>

<script>
const App = {
  d: { acc: [], ch: [] },
  hls: null,
  currUrl: '',

  init() {
    const s = localStorage.getItem('iplinks_v2');
    if (s) this.d = JSON.parse(s);
    const kv = JSON.parse(localStorage.getItem('iplinks_kv') || '{}');
    if(kv.t) document.getElementById('kv-t').value = kv.t;
    if(kv.a) document.getElementById('kv-a').value = kv.a;
    if(kv.n) document.getElementById('kv-n').value = kv.n;
    this.renderAcc();
  },

  save() {
    localStorage.setItem('iplinks_v2', JSON.stringify(this.d));
    localStorage.setItem('iplinks_kv', JSON.stringify({
      t: document.getElementById('kv-t').value,
      a: document.getElementById('kv-a').value,
      n: document.getElementById('kv-n').value
    }));
  },

  go(view) {
    document.getElementById('view-config').classList.toggle('hidden', view !== 'config');
    document.getElementById('view-list').classList.toggle('hidden', view !== 'list');
    document.getElementById('nav-config').classList.toggle('active', view === 'config');
    document.getElementById('nav-list').classList.toggle('active', view === 'list');
    if(view === 'list') this.render();
  },

  msg(t) {
    const el = document.getElementById('toast');
    el.innerText = t;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2500);
  },

  // --- SMART IMPORTER ---
  import() {
    const txt = document.getElementById('log').value;
    if(!txt.trim()) return this.msg('Empty input');

    let c = 0;

    // 1. TRY TO PARSE "SUZANOR" STYLE (M3U URL)
    // Procura por: http://host:port/get.php?username=X&password=Y
    // Isso ignora toda a ASCII art e vai direto na fonte da verdade.
    const smartRegex = /https?:\/\/([^\/:]+)(?::(\d+))?\/get\.php\?username=([^&]+)&password=([^&\s]+)/gi;
    
    let match;
    while ((match = smartRegex.exec(txt)) !== null) {
      const host = match[1];
      const port = match[2] || '80'; // Se não tiver porta, assume 80
      const user = match[3];
      const pass = match[4];
      
      // Formata URL padrão Xtream: http://user:pass@host:port
      const url = `http://${user}:${pass}@${host}:${port}`;
      
      // Evita duplicatas
      if (!this.d.acc.find(x => x.url === url)) {
        this.d.acc.push({ 
          id: Date.now() + Math.random().toString(36).substr(2, 5), 
          url: url, 
          h: host, 
          p: port, 
          u: user, 
          pw: pass, 
          s: '?' 
        });
        c++;
      }
    }

    // 2. FALLBACK (Formato padrão http://user:pass@host:port)
    // Caso o usuário cole logs limpos sem o link get.php
    if (c === 0) {
       const legacyRegex = /(https?:\/\/)([^:\s\/]+):([^@\s\/]+)@([^:\s\/]+):?(\d+)?/gi;
       while ((match = legacyRegex.exec(txt)) !== null) {
          const url = `${match[1]}${match[2]}:${match[3]}@${match[4]}:${match[5]||80}`;
          if (!this.d.acc.find(x => x.url === url)) {
             this.d.acc.push({ 
               id: Date.now() + Math.random(), 
               url: url, 
               h: match[4], 
               p: match[5]||80, 
               u: match[2], 
               pw: match[3], 
               s: '?' 
             });
             c++;
          }
       }
    }

    if (c > 0) {
      document.getElementById('log').value = ''; // Limpa o input
      this.save();
      this.renderAcc();
      this.check(); // Auto check
      this.msg(`+${c} ACCOUNTS PARSED`);
    } else {
      this.msg('NO VALID ACCESS FOUND');
    }
  },

  async check() {
    if(this.d.acc.length === 0) return;
    this.msg('Checking status...');
    for (let a of this.d.acc) {
      a.s = '...';
      this.renderAcc();
      try {
        // Timeout curto para não travar se o servidor estiver morto
        const res = await fetch(`http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}`, { signal: AbortSignal.timeout(6000) });
        const j = await res.json();
        // Verifica se o user_info existe e o status é Active
        a.s = (j.user_info && j.user_info.status === 'Active') ? 'ON' : 'OFF';
      } catch(e) { a.s = 'OFF'; }
    }
    this.save();
    this.renderAcc();
  },

  del(i) { this.d.acc.splice(i,1); this.save(); this.renderAcc(); },
  clear() { if(confirm('Reset all data?')) { this.d = { acc:[], ch:[] }; this.save(); this.renderAcc(); this.render(); } },

  renderAcc() {
    document.getElementById('accounts').innerHTML = this.d.acc.map((a, i) => `
      <div class="item">
        <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          <span class="status ${a.s==='ON'?'on':'off'}"></span> 
          <span style="color:#888; font-size:10px;">[${a.h}]</span> ${a.u}
        </div>
        <button class="btn" style="padding:2px 6px; color:red;" onclick="App.del(${i})">×</button>
      </div>
    `).join('') || '<div style="padding:10px; color:#444; text-align:center">No accounts</div>';
  },

  // --- CHANNELS ---
  async load() {
    const valid = this.d.acc.filter(a => a.s === 'ON');
    if (!valid.length) return this.msg('No active accounts');
    this.msg('Fetching channels...');
    this.d.ch = [];
    
    // Lista de prioridade (The God List)
    const keys = ['PREMIERE', 'ESPN', 'SPORTV', 'AMAZON', 'PRIME', 'HBO', 'DAZN', 'TNT', 'COMBATE', 'COMBAT'];
    
    for (const a of valid) {
      try {
        const r = await fetch(`http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}&action=get_live_streams`);
        const data = await r.json();
        if (Array.isArray(data)) {
          data.forEach(x => {
            const n = x.name.toUpperCase();
            if (keys.some(k => n.includes(k))) {
              this.d.ch.push({
                n: x.name,
                u: `http://${a.h}:${a.p}/live/${a.u}/${a.pw}/${x.stream_id}.m3u8`,
                q: n.includes('4K')?'4K':(n.includes('HD')?'HD':'SD')
              });
            }
          });
        }
      } catch(e) { console.error(e); }
    }
    this.save();
    this.go('list');
    this.msg(`${this.d.ch.length} channels loaded`);
  },

  render() {
    const q = document.getElementById('search').value.toUpperCase();
    const fq = document.getElementById('filter-q').value;
    const el = document.getElementById('grid');
    
    const filtered = this.d.ch.filter(c => {
      const matchName = c.n.toUpperCase().includes(q);
      const matchQ = fq === 'all' || c.q === fq.toUpperCase();
      return matchName && matchQ;
    });

    el.innerHTML = filtered.map(c => `
      <div class="ch-card">
        <div>
          <div class="ch-name">${c.n}</div>
          <div class="ch-meta" style="color:${c.q==='HD'?'#00e676':'#666'}">${c.q}</div>
        </div>
        <div class="ch-actions">
          <button class="btn btn-primary" onclick="App.play('${encodeURIComponent(c.u)}','${c.n.replace(/'/g,"\\'")}')">PLAY</button>
          <button class="btn" onclick="App.copyUrl('${c.u}')">LINK</button>
        </div>
      </div>
    `).join('') || '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#444">No channels found</div>';
  },

  // --- PLAYER ---
  play(url, name) {
    this.currUrl = decodeURIComponent(url);
    const v = document.getElementById('v');
    const m = document.getElementById('modal');
    m.classList.add('open');
    
    if (this.hls) this.hls.destroy();
    
    if (Hls.isSupported()) {
      this.hls = new Hls({ enableWorker: true, lowLatencyMode: true });
      this.hls.loadSource(this.currUrl);
      this.hls.attachMedia(v);
      this.hls.on(Hls.Events.MANIFEST_PARSED, () => v.play().catch(()=>{}));
      this.hls.on(Hls.Events.ERROR, (event, data) => {
         if(data.fatal) this.msg('Stream Error');
      });
    } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
      v.src = this.currUrl;
      v.play().catch(()=>{});
    }
  },

  close() {
    document.getElementById('modal').classList.remove('open');
    document.getElementById('v').pause();
    if (this.hls) this.hls.destroy();
  },

  copyUrl(url) {
    navigator.clipboard.writeText(url).then(() => this.msg('URL Copied!'));
  },
  copy() { if(this.currUrl) this.copyUrl(this.currUrl); },

  // --- EXPORT / SYNC ---
  download(type) {
    if (!this.d.ch.length) return this.msg('List is empty');
    let content, mime, name;
    if (type === 'm3u') {
      content = '#EXTM3U\n' + this.d.ch.map(c => `#EXTINF:-1 tvg-logo="" group-title="${c.q}",${c.n}\n${c.u}`).join('\n');
      mime = 'audio/x-mpegurl';
      name = 'iplinks.m3u';
    } else {
      content = JSON.stringify(this.d.ch);
      mime = 'application/json';
      name = 'iplinks.json';
    }
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], {type: mime}));
    a.download = name;
    a.click();
  },

  async sync() {
    const t = document.getElementById('kv-t').value;
    const a = document.getElementById('kv-a').value;
    const n = document.getElementById('kv-n').value;
    if(!t || !a || !n) return this.msg('Missing KV credentials');
    
    this.msg('Syncing to Cloudflare...');
    try {
      await fetch(`https://api.cloudflare.com/client/v4/accounts/${a}/storage/kv/namespaces/${n}/values/iplinks_data`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ updated: Date.now(), data: this.d.ch })
      });
      this.msg('Synced OK');
    } catch(e) { this.msg('Sync Failed'); }
  }
};

window.onload = () => App.init();
</script>
</body>
</html>
