<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>IPLINKS V17 GITHUB BRIDGE</title>
  <style>
    body { background: #050505; color: #0f0; font-family: 'Consolas', monospace; margin: 0; padding: 10px; font-size: 13px; }
    
    .w-full { width: 100%; }
    .flex { display: flex; gap: 10px; }
    .mt-1 { margin-top: 10px; }
    
    /* INPUTS */
    input, textarea, select { background: #000; border: 1px solid #333; color: #fff; padding: 10px; font-family: monospace; width: 100%; box-sizing: border-box; margin-bottom: 10px; border-radius: 4px; }
    input:focus, textarea:focus { border-color: #0f0; }
    
    /* STATUS BAR (VISUAL FEEDBACK) */
    #status-bar { background: #111; padding: 10px; border: 1px solid #333; margin-bottom: 10px; border-radius: 4px; font-size: 11px; display: none; }
    #progress-fill { height: 4px; background: #0f0; width: 0%; transition: width 0.3s; }
    #log-area { max-height: 200px; overflow-y: auto; border: 1px solid #222; padding: 10px; font-size: 11px; color: #888; white-space: pre-wrap; }
    
    /* UI */
    .btn { background: #111; border: 1px solid #333; color: #fff; padding: 12px; cursor: pointer; font-family: inherit; text-transform: uppercase; font-weight: bold; border-radius: 4px; width: 100%; margin-bottom: 5px; transition: 0.2s; }
    .btn:hover { background: #222; border-color: #666; }
    .btn-primary { background: #004400; border-color: #006600; color: #fff; }
    .btn-primary:hover { background: #006600; }
    
    .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #333; }
    .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border: 1px solid #333; border-bottom: none; margin-bottom: -1px; background: #080808; }
    .tab.on { background: #000; border-bottom: 1px solid #000; color: #0f0; }
    
    /* LISTA */
    .grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    @media (min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: #111; border: 1px solid #333; padding: 10px; border-radius: 4px; display: flex; flex-direction: column; justify-content: space-between; min-height: 90px; }
    .c-name { font-weight: bold; margin-bottom: 5px; color: #fff; }
    .c-meta { font-size: 10px; color: #666; margin-bottom: 8px; }
    .c-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
  </style>
</head>
<body>

<h1 style="text-align: center; margin-bottom: 20px; font-size: 18px; letter-spacing: 2px;">V17 <span style="color: #0f0;">GITHUB SYNC</span></h1>

<div class="tabs">
  <div class="tab on" onclick="App.show('cfg')">GERENCIADOR</div>
  <div class="tab" onclick="App.show('list')">LISTA (<span id="cnt">0</span>)</div>
</div>

<!-- CONFIG -->
<div id="cfg">
  <div class="flex" style="margin-bottom: 15px;">
    <input type="password" id="gh-token" placeholder="GITHUB PERSONAL ACCESS TOKEN (PAT)" class="w-full">
  </div>
  
  <div class="flex" style="gap: 5px; margin-bottom: 15px;">
    <input type="text" id="gh-owner" placeholder="GitHub User (Ex: seuusuario)" class="w-full">
    <input type="text" id="gh-repo" placeholder="Repo Name (Ex: iptv-lista)" class="w-full">
  </div>
  <div class="flex">
    <input type="text" id="gh-path" placeholder="Caminho do Arquivo (Ex: lista.json)" class="w-full">
    <input type="text" id="wurl" placeholder="WORKER URL (Para Stremio/Play)" class="w-full">
  </div>

  <textarea id="logs-input" rows="5" placeholder="Cole os logs SUZANOR aqui..."></textarea>
  <div class="flex">
    <button class="btn" onclick="App.import()">1. IMPORTAR LOGS</button>
    <button class="btn" onclick="App.reset()">LIMPAR</button>
  </div>

  <div id="status-bar">
    <div id="status-text">AGUARDANDO...</div>
    <div style="background:#222; height:4px; margin-top:5px; border-radius:2px; overflow:hidden;">
      <div id="progress-fill"></div>
    </div>
  </div>

  <div id="log-area"></div>

  <button class="btn btn-primary" onclick="App.processAndSync()">2. PROCESSAR E ATUALIZAR GITHUB</button>
</div>

<!-- LISTA -->
<div id="list" style="display: none;">
  <div class="grid" id="channel-grid"></div>
</div>

<script>
const App = {
  data: [], // Lista local de canais
  gh: { token: '', owner: '', repo: '', path: 'lista.json' },

  init() {
    const s = localStorage.getItem('v17_cfg');
    if(s) {
      const cfg = JSON.parse(s);
      this.gh = cfg.gh || this.gh;
      document.getElementById('gh-token').value = this.gh.token || '';
      document.getElementById('gh-owner').value = this.gh.owner || '';
      document.getElementById('gh-repo').value = this.gh.repo || '';
      document.getElementById('gh-path').value = this.gh.path || 'lista.json';
      document.getElementById('wurl').value = cfg.wurl || '';
      
      this.data = cfg.data || [];
      this.renderList();
    }
  },

  save() {
    this.gh.token = document.getElementById('gh-token').value;
    this.gh.owner = document.getElementById('gh-owner').value;
    this.gh.repo = document.getElementById('gh-repo').value;
    this.gh.path = document.getElementById('gh-path').value || 'lista.json';
    const wurl = document.getElementById('wurl').value;
    
    localStorage.setItem('v17_cfg', JSON.stringify({ gh: this.gh, data: this.data, wurl }));
  },

  log(msg) {
    const el = document.getElementById('log-area');
    el.innerHTML += `> ${msg}\n`;
    el.scrollTop = el.scrollHeight;
  },

  setStatus(msg, percent) {
    const bar = document.getElementById('status-bar');
    const fill = document.getElementById('progress-fill');
    bar.style.display = 'block';
    document.getElementById('status-text').innerText = msg;
    if (percent !== null) fill.style.width = percent + '%';
  },

  show(tab) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
    document.querySelectorAll('#cfg,#list').forEach(d=>d.style.display='none');
    document.getElementById(tab==='cfg'?'cfg':'list').style.display='block';
    document.querySelectorAll('.tab')[tab==='cfg'?0:1].classList.add('on');
    if(tab==='list') this.renderList();
  },

  // 1. IMPORTAR
  import() {
    const txt = document.getElementById('logs-input').value;
    const r = /https?:\/\/([^\/:]+)(?::(\d+))?\/get\.php\?username=([^&]+)&password=([^&\s]+)/gi;
    let m, c = 0;
    while((m=r.exec(txt))!==null) {
      const u=`http://${m[3]}:${m[4]}@${m[1]}:${m[2]||80}`;
      this.data.push({ url: u, h: m[1], p: m[2]||80, u: m[3], pw: m[4], s: '?' });
      c++;
    }
    this.log(`Importadas ${c} contas. Clique em Processar.`);
    document.getElementById('logs-input').value = '';
    this.save();
  },

  reset() {
    this.data = [];
    this.log('Dados limpos.');
    this.renderList();
    this.save();
  },

  // 2. LÓGICA DE PROCESSAMENTO (LOCAL RÁPIDO)
  async processAndSync() {
    if(!this.gh.token || !this.gh.owner || !this.gh.repo) {
      return alert('Preencha os dados do GitHub!');
    }

    this.log('INICIANDO PROCESSAMENTO LOCAL...');
    this.setStatus('Processando Contas...', 10);

    // Configurações
    const KW = ['PREMIERE', 'SPORTV', 'ESPN', 'DAZN', 'HBO MAX', 'AMAZON PRIME', 'TNT SPORTS'];
    const MAX = 90;
    
    // Helpers
    const cln = n => n.replace(/\s*(HD|SD|4K|UHD|FHD)\s*/gi,'').replace(/[^\s\-\.]+/g,'').replace(/\s+/g,' ').trim();
    const ok = n => {
      const u=n.toUpperCase();
      return KW.some(k=>u.includes(k)) && u.includes('HD') && !/\b(SD|FHD|4K|UHD)\b/.test(u);
    };

    let finalChannels = [];
    let finalStreams = {};
    let count = 0;
    const counters = {};
    const prefixMap = { 'PREMIERE':'P','SPORTV':'S','ESPN':'E','DAZN':'Z','HBO MAX':'H','PRIME':'A','TNT SPORTS':'T','OUTRO':'X' };

    // Processamento Paralelo das Contas
    const accountsToCheck = this.data;
    
    // Loop sequencial para evitar travar o navegador se for muita coisa, mas rápido
    for (let i = 0; i < accountsToCheck.length; i++) {
      const acc = accountsToCheck[i];
      this.setStatus(`Verificando Conta ${i+1}/${accountsToCheck.length}...`, Math.round((i/accountsToCheck.length)*30));
      
      try {
        const authUrl = `http://${acc.h}:${acc.p}/player_api.php?username=${acc.u}&password=${acc.pw}`;
        const authRes = await fetch(authUrl);
        if(!authRes.ok) continue;
        const authData = await authRes.json();
        
        if(!authData.user_info?.auth) continue;

        const channelsUrl = `http://${acc.h}:${acc.p}/player_api.php?username=${acc.u}&password=${acc.pw}&action=get_live_streams`;
        const chRes = await fetch(channelsUrl);
        const chData = await chRes.json();
        
        if(Array.isArray(chData)) {
          let added = 0;
          for(const ch of chData) {
            if(!ok(ch.name)) continue;
            const l = ch.name.toLowerCase(), cl = cln(l);
            if(!cl) continue;
            
            let b='OUTRO';
            if(l.includes('premiere'))b='PREMIERE';
            else if(l.includes('sportv'))b='SPORTV';
            else if(l.includes('espn'))b='ESPN';
            else if(l.includes('dazn'))b='DAZN';
            else if(l.includes('hbo max'))b='HBO MAX';
            else if(l.includes('amazon'))b='PRIME';
            else if(l.includes('tnt'))b='TNT SPORTS';

            const key = `${b}::${cl}`;
            if(!finalStreams[key]) finalStreams[key] = { sources: [] };
            
            // URL Montada
            const streamUrl = `http://${authData.server_info.url}:${authData.server_info.port}/live/${acc.u}/${acc.pw}/${ch.stream_id}.m3u8`;
            
            // Prioridade Tourobox
            const priority = acc.h.includes('Tourobox') ? 1 : 2;
            finalStreams[key].sources.push({ url: streamUrl, priority });
            added++;
          }
          this.log(`  >> ${acc.h}: +${added} canais.`);
        }
      } catch(e) {
        this.log(`  >> Erro ${acc.h}: ${e.message}`);
      }
    }

    // Montagem Final
    this.setStatus('Gerando Lista Final...', 80);
    const brandOrder = ['PREMIERE', 'SPORTV', 'ESPN', 'DAZN', 'HBO MAX', 'TNT SPORTS', 'PRIME', 'OUTRO'];
    const streamArray = Object.entries(finalStreams).map(([k, v]) => ({ key, ...v }));
    streamArray.sort((a, b) => brandOrder.indexOf(a.brand) - brandOrder.indexOf(b.brand));

    for (const data of streamArray) {
      if (finalChannels.length >= MAX) break;
      const { brand, sources } = data;
      counters[brand] = (counters[brand] || 0) + 1;
      
      const id = `ch_${count++}`, nm = `${prefixMap[brand] || 'X'}${counters[brand]}`;
      finalChannels.push({ id, type: 'tv', name: nm, poster: '' });
      
      sources.sort((a,b) => a.priority - b.priority);
      finalStreams[id] = sources[0].url;
      if(sources[1]) finalStreams[`${id}_b1`] = sources[1].url;
    }

    // 3. UPLOAD PARA GITHUB
    this.setStatus('Conectando GitHub...', 90);
    await this.uploadToGithub(finalChannels, finalStreams);
  },

  async uploadToGithub(channels, streams) {
    const content = JSON.stringify({ channels, streams, t: Date.now() });
    
    // Primeiro, pegar o SHA atual do arquivo (necessário para update)
    const url = `https://api.github.com/repos/${this.gh.owner}/${this.gh.repo}/contents/${this.gh.path}`;
    
    try {
      const getRes = await fetch(url, { 
        headers: { 'Authorization': `token ${this.gh.token}`, 'Accept': 'application/vnd.github.v3+json' } 
      });
      
      let sha = null;
      if(getRes.ok) {
        const fileData = await getRes.json();
        sha = fileData.sha;
      }

      this.setStatus('Enviando Arquivo...', 95);
      
      const putRes = await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${this.gh.token}`,
          'Content-Type': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify({
          message: `Update ${new Date().toLocaleString()}`,
          content: content,
          sha: sha
        })
      });

      if(putRes.ok) {
        this.setStatus('SUCESSO!', 100);
        this.log(`Atualizado no GitHub: ${channels.length} canais.`);
        alert('Lista atualizada no GitHub!');
        this.renderList();
      } else {
        throw new Error('Falha no upload GitHub');
      }

    } catch(e) {
      this.log(`Erro: ${e.message}`, 'error');
      alert('Erro na conexão com GitHub. Verifique Token/Repo.');
    }
  },

  renderList() {
    document.getElementById('cnt').innerText = this.data.length;
    const el = document.getElementById('channel-grid');
    el.innerHTML = this.data.map(c => `
      <div class="card">
        <div class="c-name">${c.name}</div>
        <div class="c-meta">ID: ${c.id}</div>
        <div class="c-btns">
          <button style="background:#004488; border:none; color:white;" onclick="App.play('${c.streams.main}')">PLAY</button>
          <button style="background:#aa6600; border:none; color:white;" onclick="App.cast('wvc', '${c.streams.main}')">CAST</button>
        </div>
      </div>
    `).join('');
  },

  play(url) {
    // Tenta reproduzir direto. Se falhar (HTTPS/HTTP), usa o Worker configurado
    const wurl = document.getElementById('wurl').value;
    const target = wurl ? `${wurl}/proxy?url=${encodeURIComponent(url)}` : url;
    window.open(target, '_blank');
  },

  cast(app, url) {
    if(app === 'wvc') window.location.href = `intent://x#Intent;package=com.instantbits.cast.webvideo;S.url=${encodeURIComponent(url)};end`;
    if(app === 'vlc') window.location.href = `vlc://${url}`;
  }
};

window.onload = () => App.init();
</script>
</body>
</html>
