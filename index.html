<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° IPTV Vasco 2025/2026 - Recupera√ß√£o</title>
  
  <!-- TROCAR A FONTE DO HLS (EVITA 404) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; color: #fff; min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    header { background: #18181b; border-bottom: 1px solid #27272a; padding: 20px; position: sticky; top: 0; z-index: 100; }
    h1 { font-size: 24px; background: linear-gradient(135deg, #a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
    p.subtitle { color: #71717a; margin-bottom: 0; }
    
    .tabs { display: flex; gap: 10px; margin-top: 15px; }
    .tab { padding: 10px 20px; background: #27272a; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab:hover { background: #3f3f46; }
    .tab.active { background: #a855f7; }
    
    .section { display: none; animation: fadeIn 0.3s; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .card { background: #18181b; border: 1px solid #27272a; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    .card h2 { font-size: 18px; margin-bottom: 15px; }
    
    textarea, input { width: 100%; padding: 12px; background: #000; border: 1px solid #3f3f46; border-radius: 6px; color: #fff; font-family: monospace; font-size: 13px; margin-bottom: 10px; }
    textarea { resize: vertical; min-height: 100px; }
    
    .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px; }
    .btn-primary { background: #a855f7; color: #fff; }
    .btn-primary:hover { background: #9333ea; }
    .btn-success { background: #22c55e; color: #fff; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #27272a; color: #fff; }
    .btn-secondary:hover { background: #3f3f46; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    
    .account-item { background: #000; border: 1px solid #27272a; border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .account-info { flex: 1; min-width: 200px; }
    .account-name { font-weight: 600; font-size: 14px; }
    .account-host { font-size: 11px; color: #71717a; font-family: monospace; }
    .account-actions { display: flex; gap: 8px; }
    
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .status-online { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
    .status-offline { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
    .status-checking { background: #facc15; box-shadow: 0 0 8px #facc15; }
    
    .search-bar { position: sticky; top: 100px; z-index: 50; background: #18181b; border: 1px solid #27272a; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    .search-bar input { margin: 0; }
    
    .channels-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
    
    .channel-card { background: #18181b; border: 1px solid #27272a; border-radius: 8px; padding: 15px; transition: all 0.2s; position: relative; }
    .channel-card:hover { border-color: #a855f7; box-shadow: 0 0 20px rgba(168, 85, 247, 0.2); }
    
    .channel-category { font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
    .cat-premiere { color: #22c55e; }
    .cat-amazon { color: #3b82f6; }
    .cat-espn { color: #ef4444; }
    .cat-sportv { color: #a855f7; }
    .cat-dazn { color: #a855f7; }
    .cat-hbomax { color: #f43f5e; }
    .cat-tnt { color: #6366f1; }
    .cat-hbo { color: #f43f5e; }
    .cat-tnt { color: #6366f1; }
    .cat-paraibano { color: #fbbf24; }
    .cat-outros { color: #71717a; }
    
    .channel-name { font-weight: 600; font-size: 14px; margin-bottom: 12px; line-height: 1.3; }
    
    .channel-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .channel-actions .btn { padding: 8px 12px; font-size: 12px; }
    
    .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; padding: 20px; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    
    .modal-content { background: #18181b; border: 1px solid #27272a; border-radius: 12px; max-width: 1200px; width: 100%; overflow: hidden; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #27272a; display: flex; justify-content: space-between; align-items: center; background: #000; }
    .modal-header h3 { font-size: 16px; font-weight: 600; }
    .modal-body { background: #000; aspect-ratio: 16/9; position: relative; }
    #player { width: 100%; height: 100%; background: #000; }
    
    .player-error { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: #000; padding: 20px; text-align: center; }
    .player-error.active { display: flex; }
    .player-error h4 { color: #ef4444; margin-bottom: 10px; }
    .player-error p { color: #71717a; margin-bottom: 20px; font-size: 14px; }
    
    .player-loading { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: #000; flex-direction: column; }
    .player-loading.active { display: flex; }
    .spinner { width: 50px; height: 50px; border: 4px solid #27272a; border-top-color: #a855f7; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #18181b; border: 1px solid #27272a; border-radius: 8px; padding: 15px 20px; z-index: 2000; display: none; animation: slideDown 0.3s; max-width: 90%; }
    .notification.active { display: block; }
    @keyframes slideDown { from { transform: translate(-50%, -100%); } to { transform: translate(-50%, 0); } }
    
    @media (max-width: 768px) {
      .channels-grid { grid-template-columns: 1fr; }
      .btn-group { flex-direction: column; }
      .btn-group .btn { width: 100%; }
      .account-item { flex-direction: column; align-items: flex-start; }
      .account-actions { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="notification" id="notification"></div>

  <header>
    <div class="container">
      <h1>‚ö° IPTV Vasco 2025/2026</h1>
      <p class="subtitle">PREMIERE ‚Ä¢ AMAZON PRIME ‚Ä¢ ESPN ‚Ä¢ SPORTV</p>
      <div class="tabs">
        <button class="tab active" onclick="switchTab('config')">‚öôÔ∏è Configura√ß√µes</button>
        <button class="tab" onclick="switchTab('channels')">üì∫ Canais (<span id="channel-count">0</span>)</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- CONFIG TAB -->
    <div id="tab-config" class=" section active">
      <div class="card">
        <h2>üì• Importar Aportes</h2>
        <textarea id="import-text" placeholder="Cole os logs aqui..."></textarea>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="window.importAccounts()">üîç Extrair Acessos</button>
          <button class="btn btn-secondary" onclick="document.getElementById('import-text').value = ''">Limpar</button>
        </div>
        <p style="font-size: 12px; color: #71717a; margin-bottom: 5px;">
          <strong>Nota:</strong> Se n√£o estiver encontrando canais, use a fun√ß√£o de diagn√≥stico abaixo.
        </p>
      </div>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
          <h2 style="margin: 0;">üìã Contas (<span id="accounts-count">0</span>)</h2>
          <div class="btn-group" style="margin: 0;">
            <button class="btn btn-secondary" onclick="window.checkAccountsStatus()">üîÑ Verificar Status</button>
            <button class="btn btn-primary" onclick="window.loadChannels()">üì∫ Carregar Canais (Filtro HD)</button>
            <button class="btn btn-danger" onclick="window.forceLoadAllChannels()">‚ö†Ô∏è For√ßar Tudo (Diagn√≥stico)</button>
          </div>
        </div>
        <div id="accounts-list"></div>
      </div>

      <div class="card">
        <h2>‚òÅÔ∏è Cloudflare KV (Stremio)</h2>
        <input type="password" id="kv-token" placeholder="API Token">
        <input type="text" id="kv-account" placeholder="Account ID">
        <input type="text" id="-nav-namespace" placeholder="namespace ID">
        <div class="btn-group">
          <button class="btn btn-success" onclick="window.updateKV()">‚ö° Atualizar KV</button>
          <button class="btn btn-secondary" onclick="window.exportJSON()">üìÑ Exportar JSON</button>
          <button class="btn btn-secondary" onclick="window.exportM3U()">üì∫ Exportar M3U</button>
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #27272a;">
           <h3 style="font-size: 14px; margin: 0;">üóëÔ∏è Cache</h3>
           <button class="btn btn-danger" onclick="window.clearChannelsCache()">üóëÔ∏è Limpar Cache Agora</button>
        </div>
      </div>
    </div>

    <!-- CHANNELS TAB -->
    <div id="tab-channels" class="section">
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="üîç Buscar canais..." oninput="window.filterChannels()">
      </div>
      <div id="channels-grid" class="channels-grid"></div>
    </div>
  </div>

  <!-- PLAYER MODAL -->
  <div id="player-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="player-title">üì∫ Canal</h3>
        <div class="btn-group" style="margin: 0;">
          <button class="btn btn-secondary" onclick="window.copyPlayerUrl()">üìã Copiar URL</button>
          <button class="btn btn-danger" onclick="window.closePlayer()">‚úï Fechar</button>
        </div>
      </div>
      <div class="modal-body">
        <video id="player" controls></video>
        <div class="player-loading" id="player-loading">
          <div class="spinner"></div>
          <p style="margin-top: 15px; color: #71717a;">Carregando stream...</p>
        </div>
        <div class="player-error" id="player-error">
          <h4>‚ö†Ô∏è Erro ao Carregar Stream</h4>
          <p id="error-message">N√£o foi poss√≠vel reproduzir este canal.</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="window.retryPlayer()">üîÑ Tentar Novamente</button>
            <button class="btn btn-secondary" onclick="window.copyPlayerUrl()">üìã Copiar URL</button>
            <button class="btn btn-secondary" onclick="window.closePlayer()">‚úï Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === ESTADO GLOBAL ===
    let accounts = [];
    let channels = [];
    let currentPlayerUrl = '';
    let hlsInstance = null;

    // ============================================
    // üîß FUN√á√ïES AUXILIARES
    // ============================================
    function parseIPTV(url) {
      const match = url.match(/^https?:\/\/([^:]+):([^@]+)@([^:\/]+):?(\d+)?/);
      if (!match) throw new Error('URL inv√°lida');
      const [, user, pass, host, port = '80'] = match;
      return { user, pass, host, port, endpoint: `http://${host}:${port}` };
    }

    // ============================================
    // üì¶ EXECU√á√ÉO
    // ============================================
    window.addEventListener('DOMContentLoaded', () => {
      const savedAccounts = localStorage.getItem('iptv_accounts');
      if (savedAccounts) accounts = JSON.parse(savedAccounts);
      
      const savedChannels = localStorage.getItem('iptv_channels');
      if (savedChannels) {
        try {
          channels = JSON.parse(savedChannels);
          // Valida se os canais ainda pertencem √†s contas atuais
          const validChannels = channels.filter(ch => accounts.some(a => a.id === ch.accountRef));
          setChannels(validChannels);
        } catch (e) {
          console.error('Erro ao ler cache:', e);
        }
      }

      // Renderiza contas iniciais
      renderAccounts();
      if (channels.length > 0) renderChannels();
    });

    function saveToStorage() {
      localStorage.setItem('iptv_accounts', JSON.stringify(accounts));
      localStorage.setItem('iptv_channels', JSON.stringify(channels));
      
      const kv = {
        token: document.getElementById('kv-token').value,
        accountId: document.getElementById('kv-account').value,
        namespaceId: document.getElementById('nav-namespace').value // Corre√ß√£o do ID do namespace no HTML acima
        || document.getElementById('kv-namespace').value; // Fallback caso o anterior falhar
        || document.getElementById('kv-namespace').value;
    }

    // üî• FUN√á√ïES GLOBAIS (ATRELADAS AO WINDOW)
    window.clearChannelsCache = function() {
      channels = [];
      saveToStorage();
      renderChannels();
      notify('üóëÔ∏è Cache limpo.');
    }

    window.removeAccount = function(index) {
      if (!confirm('Remover esta conta?')) return;
      accounts.splice(index, 1);
      window.clearChannelsCache(); // Limpa o cache ao remover
      saveToStorage();
      renderAccounts();
      notify('‚úÖ Conta removida');
    };

    window.notify = function(msg) {
      const el = document.getElementById('notification');
      el.textContent = msg;
      el.classList.add('active');
      setTimeout(() => el.classList.remove('active'), 3000);
    };

    window.switchTab = function(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    };

    window.importAccounts = async function() {
      const text = document.getElementById('import-text').value.trim();
      if (!text) return notify('‚ö†Ô∏è Cole os logs primeiro');
      
      // Regex para capturar user, pass, host e porta
      const regex = /https?:\/\/([^\/\s:]+)(?::(\d+))?\/get\.php\?username=([^&\s]+)&password=([^&\s]+)/gi;
      let match;
      let found = 0;
      const newAccounts = [...accounts];

      while ((match = regex.exec(text)) !== null) {
        let fullHost = match[1];
        let port = '80';
        if (match[2]) port = match[2].replace(':', '');
        const user = match[3];
        const pass = match[4];
        const cleanHost = fullHost.replace(/:\d+$/, '');
        const finalUrl = `${cleanHost}:${port}/get.php?username=${user}&password=${pass}`;
        
        if (!newAccounts.find(a => a.url === finalUrl)) {
          newAccounts.push({
            id: `${cleanHost}-${user}-${Date.now()}`,
            name: `${cleanHost.split('.')[0]}-${user.slice(0, 6)}`,
            url: finalUrl,
            status: 'checking'
          });
          found++;
        }
      }
      
      if (found > 0) {
        accounts = newAccounts;
        document.getElementById('import-text').value = '';
        window.clearChannelsCache();
        saveToStorage();
        renderAccounts();
        notify(`‚úÖ ${found} acessos importados`);
        window.checkAccountsStatus();
      } else {
        notify('‚ö†Ô∏è Nenhum acesso v√°lido encontrado');
      }
    };

    window.checkAccountsStatus = async () => {
      if (accounts.length === 0) return notify('‚ö†Ô∏è Adicione contas primeiro');
      
      accounts.forEach(acc => acc.status = 'checking');
      renderAccounts();
      notify('üîÑ Verificando status...');
      
      const checks = accounts.map(async (acc, i) => {
        try {
          const { user, pass, host, port, endpoint } = parseIPTV(acc.url);
          const authUrl = `${endpoint}/player_api.php?username=${user}&password=${pass}`;
          
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout
          
          const res = await fetch(authUrl, { signal: controller.signal });
          clearTimeout(timeout);
          
          if (res.ok) {
            const data = await res.json();
            accounts[i].status = data.user_info?.auth ? 'online' : 'offline';
          } else {
            accounts[i].status = 'offline';
          }
        } catch {
          accounts[i].status = 'offline';
        }
      });
      
      await Promise.all(checks);
      saveToStorage();
      renderAccounts();
      notify('‚úÖ Verifica√ß√£o conclu√≠da');
    };

    window.loadChannels = async function() {
      if (accounts.length === 0) return notify('‚ö†Ô∏è Adicione contas primeiro');
      
      const activeAccounts = accounts.filter(a => a.status === 'online');
      if (activeAccounts.length === 0) {
        return notify('‚ö†Ô∏è Nenhuma conta online. Verifique o status primeiro.');
      }
      
      notify('üîÑ Carregando canais HD...');
      window.clearChannelsCache();
      channels = [];
      
      const keywords = [
        'PREMIERE', 'PREMIERE FC', 'PREMIERE CLUBES',
        'AMAZON PRIME', 'PRIME VIDEO', 'AMAZON', 'PRIME SPORTS',
        'ESPN', 'ESPN 2', 'ESPN 3', 'ESPN BRASIL', 'ESPN4', 'ESPN BRASIL',
        'SPORTV', 'SPOR TV', 'SPORTV 2', 'SPORTV 3', 'SPORTV 4', 'SPOR TV HD',
        'DAZN', 'HBO MAX', 'HBO MAX 1', 'HBO MAX 2',
        'TNT SPORTS', 'TNT SPORTS 1', 'TNT SPORTS 2', 'TNT SPORTS 3',
        'HBO', 'HBO 1', 'HBO 2',
        'TNT', 'TNT 1', 'TNT 2', 'TNT 3'
      ];
      
      for (const account of activeAccounts) {
        console.log(`üì° Processando: ${account.name}`); 
        
        try {
          const { user, pass, host, port, endpoint } = parseIPTV(account.url);
          
          // 1. Auth
          const authRes = await fetch(`${endpoint}/player_api.php?username=${user}&password=${pass}`);
          if (!authRes.ok) continue;
          const authData = await authRes.json();
          if (!authData.user_info?.auth) continue;
          
          // 2. Channels
          const channelsUrl = `${endpoint}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
          const channelsRes = await fetch(channelsUrl);
          if (!channelsRes.ok) continue;
          
          const channelsData = await channelsRes.json();
          if (!Array.isArray(channelsData)) continue;
          
          console.log(`   üìä Total bruto na conta: ${channelsData.length} canais (Bruto)`);
          
          let loadedCount = 0;
          
          for (const ch of channelsData) {
            const upper = ch.name.toUpperCase();
            const isTarget = keywords.some(kw => upper.includes(kw.toUpperCase()));
            if (!isTarget) continue;
            
            // Filtro de Qualidade Relaxado (Diagn√≥stico aceita tudo)
            // Isso garante que voc√™ veja canais mesmo que n√£o tenham "HD" no nome, caso o formato do servidor tenha mudado.
            // Se quiser voltar ao filtro estrito "HD OBRIGAT√ìRIO", descomente o bloco `// const isHD = ...` abaixo.
            
            const streamUrl = `http://${host}:${port}/live/${user}/${pass}/${ch.stream_id}.m3u8`;
            
            // Verifica duplicatas
            const channelId = `${account.id}-${ch.stream_id}`;
            if (!channels.find(c => c.id === channelId)) {
              channels.push({
                id: channelId,
                name: ch.name,
                url: streamUrl,
                account: account.name,
                accountId: account.id,
                category: ch.category
              });
              loadedCount++;
            }
          }
          
          console.log(`   ‚úÖ ${account.name}: ${loadedCount} canais v√°lidos encontrados.`);
        } catch (error) {
          console.error(`‚ùå Erro em ${account.name}:`, error);
          notify(`‚ùå ${account.name}: Erro ao carregar`);
        }
      }
      
      if (channels.length === 0) {
        notify('‚ö†Ô∏è Nenhum canal v√°lido encontrado. Tente o bot√£o "For√ßar Tudo".');
      } else {
        saveToStorage();
        renderChannels();
        window.switchTab('channels');
        notify(`‚ö° Recupera√ß√£o: ${channels.length} canais carregados!`);
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ö° FUN√á√ÉO DE FOR√áAR TUDO (DIAGN√ìSTICO)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.forceLoadAllChannels = async function() {
      if (accounts.length === 0) return notify('‚ö†Ô∏è Adicione contas primeiro');
      
      const activeAccounts = accounts.filter(a => a.status === 'online');
      if (activeAccounts.length === 0) return notify('‚ö†Ô∏è Nenhuma conta online.');
      
      notify('üö® Modo Diagn√≥stico: Lendo tudo (SD, FHD, 4K, UHD) para encontrar o que parou de funcionar...');
      channels = [];
      
      for (const account of activeAccounts) {
        console.log(`üì° Lendo BRUTO de ${account.name} (Diagn√≥stico)...`);
        
        try {
          const { user, pass, host, port } = parseIPTV(account.url);
          const baseUrl = `http://${host}:${port}`;
          
          // Auth
          const authRes = await fetch(`${baseUrl}/player_api.php?username=${user}&password=${pass}`);
          if (!authRes.ok) continue;
          const authData = await authRes.json();
          if (!authData.user_info?.auth) continue;
          
          // Channels
          const channelsUrl = `${baseUrl}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
          const channelsRes = await fetch(channelsUrl);
          if (!channelsRes.ok) continue;
          
          const channelsData = await channelsRes.json();
          if (!Array.isArray(channelsData)) continue;
          
          console.log(`   üìä Total bruto na conta: ${channelsData.length} canais.`);
          
          let loadedCount = 0;
          
          // L√≥gica Diagn√≥stica (Agora aceita tudo o que n√£o for SD)
          for (const ch of channelsData) {
            const upper = ch.name.toUpperCase();
            
            // Verifica se √© da lista de interesse
            const isTarget = [
              'PREMIERE', 'PREMIERE FC', 'PREMIERE CLUBES',
              'AMAZON PRIME', 'PRIME VIDEO', 'AMAZON', 'PRIME SPORTS',
              'ESPN', 'ESPN 2', 'ESPN 3', 'ESPN BRASIL', 'ESPN 4', 'ESPN BRASIL',
              'SPORTV', 'SPOR TV', 'SPORTV 2', 'SPORTV 3', 'SPORTV 4', 'SPOR TV HD', 'SPOR TV HD', 'SPORTV 2 HD', 'SPORTV 3 HD', 'SPOR TV 4 HD', 'SPORTV 5 HD',
              'DAZN', 'DAZN 1', 'DAZN 2', 'DAZN 3', 'DAZN 4',
              'HBO MAX', 'HBO MAX', 'HBO MAX 1', 'HBO MAX 2', 'HBO MAX 3', 'HBO MAX 4',
              'HBO', 'HBO 1', 'HBO 2',
              'TNT SPORTS', 'TNT SPORTS 1', 'TNT SPORTS 2', 'TNT SPORTS 3',
              'TNT', 'TNT 1', 'TNT 2', 'TNT 3',
              'HBO MAX', 'HBO MAX'
            ].some(kw => upper.includes(kw.toUpperCase()));
            
            if (!isTarget) continue;
            
            // Verifica√ß√£o de qualidade (Diagn√≥stico aceita tudo)
            const isHD = /\b(HD|FHD|FULLHD|1080p|4K|UHD)\b/i.test(upper);
            
            // Se n√£o for HD, ignora (√© SD ou Muito baixa qualidade)
            if (!isHD) continue;
            
            const streamUrl = `http://${host}:${port}/live/${user}/${pass}/${ch.stream_id}.m3u8`;
            
            let category = 'OUTROS';
            if (upper.includes('PREMIERE')) category = 'PREMIERE';
            else if (upper.includes('AMAZON') || upper.includes('PRIME')) category = 'AMAZON PRIME';
            else if (upper.includes('ESPN')) category = 'ESPN';
            else if (upper.includes('SPORTV') || upper.includes('SPOR TV')) category = 'SPORTV';
            else if (upper.includes('DAZN')) category = 'DAZN';
            else if (upper.includes('HBO')) category = 'HBO MAX';
            else if (upper.includes('TNT')) category = 'TNT SPORTS';
            else if (upper.includes('HBO MAX')) category = 'HBO MAX';
            else if (upper.includes('TNT SPORTS')) category = 'TNT SPORTS';
            else if (upper.includes('HBO MAX')) category = 'HBO MAX';
            else if (upper.includes('TNT')) category = 'TNT';
            else category = 'OUTROS';
            
            // Detectar categorias extras
            if (upper.includes('HBO MAX')) category = 'HBO MAX';
            else if (upper.includes('TNT SPORTS')) category = 'TNT SPORTS';
            else if (upper.includes('TNT SPORTS')) category = 'TNT SPORTS';
            
            // Formatar ID √öNICO para evitar conflitos em m√∫ltiplos acessos no diagn√≥stico
            const channelId = `${account.id}-${ch.stream_id}`;
            
            channels.push({
              id: channelId,
              name: ch.name,
              url: streamUrl,
              account: account.name,
              category
            });
            loadedCount++;
          }
          
          console.log(`   ‚úÖ ${account.name}: ${loadedCount} canais encontrados.`);
        } catch (error) {
          console.error(`‚ùå Erro diagn√≥stico em ${account.name}:`, error);
          notify(`‚ùå ${account.name}: Erro ao carregar (Diagn√≥stico)`);
        }
      }
      
      if (channels.length === 0) {
        notify('‚ö†Ô∏è Modo Diagn√≥stico: Nenhum canal encontrado. As contas podem estar offline ou expiradas.');
      } else {
        saveToStorage();
        window.switchTab('channels');
        notify(`‚ö° Diagn√≥stico: ${channels.length} canais carregados! Se aparecerem nomes estranhos, as contas provavelmente mudaram.`);
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ö° FUN√á√ïES DO PLAYER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.playChannel = function(url, title) {
      currentPlayerUrl = url;
      document.getElementById('player-title').textContent = `üì∫ ${title}`;
      document.getElementById('player-modal').classList.add('active');
      document.getElementById('player-loading').classList.add('active');
      document.getElementById('player-error').classList.remove('active');
      
      const video = document.getElementById('player');
      video.style.display = block';
      
      if (hlsInstance) {
        hlsInstance.destroy();
        hlsInstance = null;
      }
      
      if (Hls.isSupported()) {
        // CORRE√á√ÉO: enableWorker (Sem o "ker")
        hlsInstance = new Hls({
          enableWorker: true, 
          lowLatencyMode: false,
          backBufferLength: 90,
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
          maxBufferSize: 60 * 1000 * 1000,
          maxBufferHole: 0.5,
          manifestLoadingTimeOut: 20000,
          manifestLoadingMaxRetry: 3,
          levelLoadingTimeOut: 10000,
          levelLoadingTimeOut: 10000,
          fragLoadingTimeOut: 20000,
          fragLoadingMaxRetry: 6
        });
        
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
          document.getElementById('player-loading').classList.remove('active');
          video.play().catch(e => showPlayerError('Erro ao iniciar reprodu√ß√£o.'));
        });
        
        hlsInstance.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                showPlayerError('Erro de rede ou bloqueio.');
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                hlsInstance.recoverMediaError();
                break;
              default:
                showPlayerError('Erro fatal. Copie a URL.');
                break;
            }
          }
        });
        
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => {
          document.getElementById('player-loading').classList.remove('active');
          video.play().catch(e => showPlayerError('Erro ao iniciar: ' + e.message));
        });
        video.addEventListener('error', () => {
          showPlayerError('Erro ao carregar stream.');
        });
      } else {
        showPlayerError('Navegador incompat√≠vel.');
      }
    };

    window.showPlayerError = function(message) {
      document.getElementById('player-loading').classList.remove('active');
      document.getElementById('player').style.display = 'none';
      document.getElementById('error-message').textContent = message;
      document.getElementById('player-error').classList.add('active');
    };

    window.retryPlayer = function() {
      const title = document.getElementById('player-title').textContent.replace('üì∫ ', '');
      window.playChannel(window.currentPlayerUrl, title);
    };

    window.copyPlayerUrl = function() {
      if (window.currentPlayerUrl) {
        navigator.clipboard.writeText(window.currentPlayerUrl).then(() => {
          notify('‚úÖ URL copiada!');
        }).catch(() => {
          console.error('Erro ao copiar URL');
        });
      }
    };

    window.closePlayer = function() {
      if (window.hlsInstance) {
        window.hlsInstance.destroy();
        window.hlsInstance = null;
      }
      document.getElementById('player').pause();
      document.getElementById('player').src = '';
      document.getElementById('player-modal').classList.remove('active');
      window.currentPlayerUrl = '';
    };

    window.copyUrl = function(url) {
      if (url) {
        navigator.clipboard.writeText(url).then(() => {
          notify('‚úÖ URL copiada!');
        }).catch(() => {
          console.error('Erro ao copiar URL');
        });
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üü° SYNC & EXPORTA√á√ÉO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    window.updateKV = async function() {
      const token = document.getElementById('kv-token').value;
      const accountId = document.getElementById('kv-account').value;
      const namespaceId = document.getElementById('kv-namespace').value;
      
      if (!token || !accountId || !namespaceId) {
        return notify('‚ö†Ô∏è Configure as credenciais da Cloudflare primeiro');
      }
      
      if (window.channels.length === 0) return notify('‚ö†Ô∏è Carregue os canais primeiro');
      
      notify('üîÑ Atualizando Cloudflare KV...');
      
      const payload = {
        version: '1.0.0',
        updatedAt: new Date().toISOString(),
        totalChannels: window.channels.length,
        categories: ['premiere', 'amazon_prime', 'espn', 'sportv', 'dazn', 'hbo max', 'tnt sports', 'outros', 'hbo', 'tnt'],
        streams: {},
        accountsCount: window.accounts.filter(a => a.status === 'online').length
      };
      
      // Group by category
      window.channels.forEach(ch => {
        let catKey = ch.category.toLowerCase().replace(/\s+/g, '_'); 
        if (!payload.streams[catKey]) payload.streams[catKey] = [];
        payload.streams[catKey].push({
          name: ch.name,
          url: ch.url,
          behaviorHints: { notWebReady: true }
        });
      });
      
      try {
        const kvUrl = `https://api.cloudflare.com/client/v4/accounts/${accountId}/storage/kv/namespaces/${namespaceId}/values/iptv_channels`;
        const res = await fetch(kvUrl, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (res.ok) {
          saveToStorage();
          notify('‚úÖ KV atualizado com sucesso!');
        } else {
          const error = await res.text();
          notify(`‚ùå Erro: ${error}`);
        }
      } catch (error) {
        notify(`‚ùå Erro: ${error.message}`);
      }
    };

    // Exportar
    window.exportJSON = function() {
      if (!window.channels || window.channels.length === 0) return notify('‚ö†Ô∏è Carregue os canais primeiro');
      
      const data = { version: '1.0.0', exported: new Date().toISOString(), channels: window.channels };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `iptv-channels-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.retoObjectURL(url);
      notify('‚úÖ JSON exportado!');
    };

    window.exportM3U = function() {
      if (!window.channels || window.channels.length === 0) return notify('‚ö†Ô∏è Carregue os canais primeiro');
      
      let m3u = '#EXTM3U\n\n';
      window.channels.forEach(ch => {
        m3u += `#EXTINF:-1 tvg-name="${ch.name}" group-title="${ch.category}",${ch.name}\n${ch.url}\n\n`;
      });
      
      const blob = new Blob([m3u], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `iptv-playlist-${new Date().toISOString().split('T')[0]}.m3u`;
      a.click();
      URL.revokeObjectURL(url);
      notify('‚úÖ M3U exportado!');
    };

    // Atalizando o Player
    window.retryPlayer = function() {
      const title = document.getElementById('player-title').textContent.replace('üì∫ ', '');
      window.playChannel(window.currentPlayerUrl, title);
    };

    window.closePlayer = function() {
      if (window.hlsInstance) {
        window.hlsInstance.destroy();
        window.hlsInstance = null;
      }
      document.getElementById('player').pause();
      document.getElementById('player').src = '';
      document.getElementById('player-modal').classList.remove('active');
      window.currentPlayerUrl = '';
    };

    // Fix para os bot√µes do HTML
    document.getElementById('importAccounts').onclick = window.importAccounts;
    document.getElementById('loadChannels').onclick = window.loadChannels;
    document.getElementById('checkAccountsStatus').onclick = window.checkAccountsStatus;
    document.getElementById('forceLoadAllChannels').onclick = window.forceLoadAllChannels;
    
    // Render inicial
    if (typeof window.renderChannels === 'function') window.renderChannels(); 
    if (typeof window.renderAccounts === 'function') window.renderAccounts();
    if (typeof window.channelCount === 'undefined') {
       // Inicializa contadores se a fun√ß√£o render n√£o rodar automaticamente no load
       if(document.getElementById('accounts-list').length === 0) {
         document.getElementById('accounts-count').textContent = '0';
       }
    }

    // Fim do HTML
    window.switchTab = function(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    };
  </script>
</body>
</html>
