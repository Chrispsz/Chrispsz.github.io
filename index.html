<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IPLINKS V8 MOBILE</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root { --bg: #050505; --fg: #00ff9d; --err: #ff4444; --dim: #333; --panel: #111; --warn: #ffbb00; }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: #ccc; font-size: 14px; overflow-x: hidden; touch-action: manipulation; }
    
    .c { max-width: 1000px; margin: 0 auto; padding: 10px; display: flex; flex-direction: column; min-height: 100vh; }
    .top { flex: 0 0 auto; }
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; margin-top: 10px; }
    
    .hd { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--dim); padding-bottom: 15px; margin-bottom: 15px; }
    h1 { color: var(--fg); font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
    
    nav { display: flex; gap: 5px; background: var(--panel); padding: 5px; border-radius: 8px; }
    nav button { background: none; border: none; color: #666; cursor: pointer; padding: 8px 12px; text-transform: uppercase; font-weight: bold; font-size: 11px; flex: 1; border-radius: 4px; transition: 0.2s; }
    nav button.on { color: var(--bg); background: var(--fg); }

    /* INPUTS & BUTTONS (MOBILE FRIENDLY) */
    .btn { background: var(--panel); border: 1px solid var(--dim); color: #fff; cursor: pointer; padding: 12px 16px; font-family: inherit; font-size: 13px; text-transform: uppercase; font-weight: 600; transition: 0.2s; border-radius: 6px; width: 100%; margin-bottom: 8px; }
    .btn:active { transform: scale(0.98); }
    .btn.danger { border-color: var(--err); color: var(--err); }
    .btn-primary { background: var(--fg); color: #000; border: none; }
    
    input, textarea, select { background: #000; border: 1px solid var(--dim); color: #fff; padding: 12px; font-family: inherit; width: 100%; margin-bottom: 10px; border-radius: 6px; font-size: 14px; }
    textarea { height: 80px; resize: vertical; }
    
    /* CONSOLE */
    #console-box {
      flex: 1; background: #000; border: 1px solid var(--dim);
      padding: 10px; overflow-y: auto; font-size: 11px; color: #888; font-family: monospace;
      margin-bottom: 10px; display: none; /* Hidden by default on mobile */
      flex-direction: column-reverse; border-radius: 6px;
    }
    .log-line { padding: 4px 0; border-bottom: 1px solid #111; }
    .log-ok { color: var(--fg); }
    .log-err { color: var(--err); }
    .log-warn { color: var(--warn); }

    /* LISTS */
    .list { border-top: 1px solid var(--dim); max-height: 200px; overflow-y: auto; margin-bottom: 15px; }
    .row { border-bottom: 1px solid var(--dim); padding: 12px; display: flex; justify-content: space-between; align-items: center; }
    .row:active { background: #0a0a0a; }
    .dot { width: 10px; height: 10px; background: currentColor; border-radius: 50%; display: inline-block; margin-right: 10px; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 10px; overflow-y: auto; padding-bottom: 50px; }
    @media(min-width: 600px) {
      .grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
    }
    
    .card { background: var(--panel); border: 1px solid var(--dim); padding: 12px; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; min-height: 90px; }
    .card:active { border-color: var(--fg); }
    .c-name { font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #eee; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .c-meta { font-size: 11px; color: #666; margin-bottom: 10px; }
    .c-act { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    
    /* MODAL FULLSCREEN ON MOBILE */
    #m { position: fixed; inset: 0; background: #000; z-index: 999; display: none; align-items: center; justify-content: center; flex-direction: column; }
    #m.open { display: flex; }
    #v { width: 100%; height: 100%; object-fit: contain; background: #000; }
    
    .ctrl-mobile { 
      position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); 
      padding: 15px; display: flex; gap: 10px; z-index: 10; backdrop-filter: blur(5px);
    }
    
    /* COMMAND CENTER (EXTERNAL LAUNCHER) */
    #cmd-center {
      position: absolute; inset: 0; background: #000; 
      display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; padding: 20px; text-align: center;
    }
    .cmd-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; width: 100%; max-width: 400px; }
    
    .cmd-btn {
      background: #222; border: 1px solid #444; padding: 20px; color: #fff; cursor: pointer; 
      display: flex; align-items: center; gap: 15px; border-radius: 12px; transition: 0.2s; font-weight: 600;
    }
    .cmd-btn:active { background: #333; transform: scale(0.98); }
    .cmd-icon { font-size: 28px; min-width: 40px; }
    
    .hidden { display: none !important; }
    .mt-1 { margin-top: 10px; }
  </style>
</head>
<body>

<div class="c">
  <div class="top">
    <div class="hd">
      <h1>IPLINKS <span style="font-size:0.5em; vertical-align:top; color:var(--fg)">V8 MOBILE</span></h1>
    </div>
    <nav>
      <button id="b-cfg" class="on" onclick="V.go('cfg')">CONFIG</button>
      <button id="b-lst" onclick="V.go('lst')">LIST</button>
      <button id="b-dbg" onclick="V.go('dbg')">LOGS</button>
    </nav>
  </div>

  <!-- CONFIG TAB -->
  <div id="cfg" class="main">
    <textarea id="in" placeholder="Cole seus logs ou links M3U aqui..."></textarea>
    <button class="btn btn-primary" onclick="V.imp()">IMPORTAR LOGS</button>
    
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <button class="btn" onclick="V.chk()">VERIFICAR CONTA</button>
      <button class="btn danger" onclick="V.rst()">LIMPAR</button>
    </div>
    
    <div class="list" id="acc"></div>
    
    <div style="border-top:1px solid #333; padding-top:15px; margin-top:10px;">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; color:#888; font-size:12px;">
        <input type="checkbox" id="force-all" style="width:20px; height:20px;">
        <span>Carregar TODOS os canais (Ignorar filtro)</span>
      </div>
      <button class="btn btn-primary" onclick="V.load()">CARREGAR CANAIS</button>
    </div>
  </div>

  <!-- LIST TAB -->
  <div id="lst" class="main hidden">
    <div style="position:sticky; top:0; background:var(--bg); z-index:5; padding-bottom:10px; border-bottom:1px solid var(--dim);">
      <input type="text" id="s" placeholder="üîç Buscar canal..." onkeyup="V.rnd()" style="margin:0 0 10px 0;">
      <select id="f-q" onchange="V.rnd()" style="margin:0;">
        <option value="all">TODAS QUALIDADES</option>
        <option value="hd">HD / FHD</option>
        <option value="sd">SD</option>
        <option value="4k">4K</option>
      </select>
    </div>
    <div class="grid" id="g" style="margin-top:10px;"></div>
  </div>

  <!-- LOGS TAB -->
  <div id="dbg" class="main hidden">
    <div style="display:flex; justify-content: space-between; margin-bottom: 10px;">
      <span style="color:#666; font-weight:bold;">SYSTEM LOGS</span>
      <button class="btn" style="width:auto; padding:5px 10px;" onclick="V.clrLog()">LIMPAR</button>
    </div>
    <div id="console-box"></div>
  </div>
</div>

<!-- PLAYER MODAL -->
<div id="m">
  <video id="v" controls playsinline></video>
  
  <!-- CONTROLES MOBILE -->
  <div class="ctrl-mobile" id="ctrl-ui">
    <button class="btn" style="background:rgba(255,255,255,0.2); backdrop-filter:none;" onclick="V.cp()">COPIAR LINK</button>
    <button class="btn danger" style="background:rgba(255,68,68,0.2); backdrop-filter:none; border-color:var(--err);" onclick="V.x()">FECHAR</button>
  </div>

  <!-- COMMAND CENTER (OVERRIDES VIDEO ON ERROR) -->
  <div id="cmd-center">
    <h2 style="color:var(--err); margin-bottom:15px; font-size:18px;">‚ö†Ô∏è STREAM BLOQUEADO</h2>
    <p style="color:#ccc; font-size:13px; max-width:300px; line-height:1.5; margin-bottom:20px;">
      O navegador bloqueou o v√≠deo inseguro (HTTP) neste site seguro (HTTPS).<br>
      <strong>Solu√ß√£o:</strong> Use um player externo abaixo.
    </p>
    
    <div class="cmd-grid">
      <!-- MX PLAYER -->
      <button class="cmd-btn" onclick="V.launch('mx')">
        <span class="cmd-icon">ü§ñ</span>
        <div style="text-align:left;">
          <div>MX Player</div>
          <div style="font-size:10px; color:#888; font-weight:normal;">Melhor para Android</div>
        </div>
      </button>
      
      <!-- WEB VIDEO CASTER -->
      <button class="cmd-btn" onclick="V.launch('wvc')">
        <span class="cmd-icon">üì°</span>
        <div style="text-align:left;">
          <div>Web Video Caster</div>
          <div style="font-size:10px; color:#888; font-weight:normal;">Enviar para TV/Chromecast</div>
        </div>
      </button>
      
      <!-- VLC -->
      <button class="cmd-btn" onclick="V.launch('vlc')">
        <span class="cmd-icon">ü¶Ü</span>
        <div style="text-align:left;">
          <div>VLC</div>
          <div style="font-size:10px; color:#888; font-weight:normal;">Universal</div>
        </div>
      </button>

      <!-- COPY -->
      <button class="cmd-btn" onclick="V.launch('copy')">
        <span class="cmd-icon">üìã</span>
        <div style="text-align:left;">
          <div>Copiar Link</div>
          <div style="font-size:10px; color:#888; font-weight:normal;">Colar em outro app</div>
        </div>
      </button>
    </div>
    
    <button class="btn mt-1" style="width:200px; margin-top:30px; background:none; border:1px solid #444; color:#888;" onclick="V.retryInternal()">Tentar Player Interno</button>
  </div>
</div>

<script>
const V = {
  d: { acc: [], ch: [] },
  hls: null,
  cur: '',
  
  // Configs
  proxies: ['https://api.allorigins.win/raw?url=', 'https://corsproxy.io/?'],
  proxyIdx: 0,
  apiProxy: 'https://api.allorigins.win/raw?url=',
  useProxy: location.protocol === 'https:',

  init() {
    console.log("IPLINKS V8 MOBILE INIT");
    const s = localStorage.getItem('iplinks_v8');
    if (s) this.d = JSON.parse(s);
    this.rndAcc();
    // Previne zoom duplo no mobile
    document.addEventListener('dblclick', function(event) {
      event.preventDefault();
    }, { passive: false });
  },

  sv() { localStorage.setItem('iplinks_v8', JSON.stringify(this.d)); },

  go(x) {
    ['cfg','lst','dbg'].forEach(id => document.getElementById(id).classList.add('hidden'));
    ['b-cfg','b-lst','b-dbg'].forEach(id => document.getElementById(id).classList.remove('on'));
    document.getElementById(x).classList.remove('hidden');
    document.getElementById('b-'+x).classList.add('on');
    if (x === 'lst') this.rnd();
  },

  log(msg, type = 'info') {
    const box = document.getElementById('console-box');
    if(!box) return;
    const div = document.createElement('div');
    div.className = `log-line log-${type}`;
    const time = new Date().toLocaleTimeString().split(' ')[0];
    div.innerHTML = `<span style="color:#444">[${time}]</span> ${msg}`;
    box.prepend(div);
    if(box.children.length > 50) box.lastChild.remove();
  },
  clrLog() { const b = document.getElementById('console-box'); if(b) b.innerHTML = ''; },

  async fetchRaw(url, label) {
    try {
      let res = this.useProxy ? await fetch(this.apiProxy + encodeURIComponent(url)) : await fetch(url);
      if (!res.ok) throw new Error(res.status);
      const text = await res.text();
      if (text.length < 50 && text.trim().startsWith('<')) return null;
      return JSON.parse(text);
    } catch (e) { return null; }
  },

  imp() {
    const txt = document.getElementById('in').value;
    if (!txt.trim()) return alert('Cole os logs primeiro!');
    let c = 0;
    const re = /https?:\/\/([^\/:]+)(?::(\d+))?\/get\.php\?username=([^&]+)&password=([^&\s]+)/gi;
    let m;
    while ((m = re.exec(txt)) !== null) {
      const u = `http://${m[3]}:${m[4]}@${m[1]}:${m[2]||80}`;
      if (!this.d.acc.find(x => x.url === u)) {
        this.d.acc.push({ id: Date.now()+Math.random(), url: u, h: m[1], p: m[2]||80, u: m[3], pw: m[4], s: '?' });
        c++;
      }
    }
    if (c > 0) {
      document.getElementById('in').value = '';
      this.sv();
      this.rndAcc();
      this.chk();
      alert(`${c} contas importadas!`);
    } else { alert('Nenhum acesso encontrado.'); }
  },

  async chk() {
    for (let a of this.d.acc) {
      a.s = '..';
      this.rndAcc();
      const url = `http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}`;
      const data = await this.fetchRaw(url, `CHK`);
      a.s = (data && data.user_info && data.user_info.status === 'Active') ? 'ON' : 'OFF';
    }
    this.sv();
    this.rndAcc();
  },

  async load() {
    const valid = this.d.acc.filter(a => a.s === 'ON');
    const target = valid.length ? valid : this.d.acc;
    if (!target.length) return alert('Nenhuma conta online.');
    
    this.d.ch = [];
    const forceAll = document.getElementById('force-all').checked;
    const keys = ['PREMIERE', 'ESPN', 'SPORTV', 'AMAZON', 'PRIME', 'HBO', 'DAZN', 'TNT'];
    
    for (const a of target) {
      const url = `http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}&action=get_live_streams`;
      const data = await this.fetchRaw(url, `LOAD`);
      
      if (Array.isArray(data)) {
        data.forEach(x => {
          const n = x.name.toUpperCase();
          let isTarget = forceAll ? true : keys.some(k => n.includes(k));
          if (isTarget) {
            this.d.ch.push({
              n: x.name,
              u: `http://${a.h}:${a.p}/live/${a.u}/${a.pw}/${x.stream_id}.m3u8`,
              q: n.includes('4K')?'4K':(n.includes('HD')?'HD':'SD')
            });
          }
        });
      }
    }
    this.sv();
    this.go('lst');
  },

  rndAcc() {
    document.getElementById('acc').innerHTML = this.d.acc.map((a, i) => `
      <div class="row">
        <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          <span class="dot" style="color:${a.s==='ON'?'#00ff9d':(a.s==='OFF'?'#ff4444':'#666')}"></span>
          <span style="color:#888; font-size:12px;">${a.h}</span>
        </div>
        <button onclick="V.del(${i})" style="background:none; border:none; color:red; font-size:18px;">&times;</button>
      </div>
    `).join('') || '<div style="padding:20px; text-align:center; color:#555">Nenhuma conta</div>';
  },

  rnd() {
    const q = document.getElementById('s').value.toUpperCase();
    const fq = document.getElementById('f-q').value;
    const el = document.getElementById('g');
    const flt = this.d.ch.filter(c => {
      const ok = c.n.toUpperCase().includes(q);
      const okQ = fq === 'all' || c.q === fq.toUpperCase();
      return ok && okQ;
    });

    el.innerHTML = flt.map(c => `
      <div class="card">
        <div>
          <div class="c-name">${c.n}</div>
          <div class="c-meta" style="color:${c.q==='HD'?'#00ff9d':'#555'}">${c.q}</div>
        </div>
        <div class="c-act">
          <button class="btn btn-primary" onclick="V.pl('${encodeURIComponent(c.u)}','${c.n.replace(/'/g,"\\'")}')">PLAY</button>
          <button class="btn" onclick="V.cpU('${c.u}')">LINK</button>
        </div>
      </div>
    `).join('') || '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#444">Nenhum canal encontrado</div>';
  },

  pl(url, name) {
    this.cur = decodeURIComponent(url);
    this.proxyIdx = 0;
    const v = document.getElementById('v');
    const m = document.getElementById('m');
    const cc = document.getElementById('cmd-center');
    const ctrl = document.getElementById('ctrl-ui');
    
    m.classList.add('open');
    cc.style.display = 'none';
    ctrl.style.display = 'flex';
    v.style.display = 'block';
    this.initHls(v, cc);
  },

  initHls(video, fallback) {
    if (this.hls) this.hls.destroy();
    
    if (Hls.isSupported()) {
      this.hls = new Hls({ enableWorker: true, debug: false, xhrSetup: (xhr, reqUrl) => {
        if (this.useProxy) {
          const pUrl = this.proxies[this.proxyIdx] + encodeURIComponent(reqUrl);
          xhr.open('GET', pUrl, true);
        } else {
          xhr.open('GET', reqUrl, true);
        }
      }});
      
      this.hls.loadSource(this.cur);
      this.hls.attachMedia(video);
      this.hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
      this.hls.on(Hls.Events.ERROR, (e, d) => {
        if (d.fatal) {
          if (this.proxyIdx < this.proxies.length - 1 && this.useProxy) {
            this.proxyIdx++;
            this.hls.destroy();
            this.initHls(video, fallback);
          } else {
            // SHOW COMMAND CENTER
            video.pause();
            video.style.display = 'none';
            document.getElementById('ctrl-ui').style.display = 'none';
            fallback.style.display = 'flex';
          }
        }
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = this.cur;
      video.play().catch(()=>{});
    }
  },

  retryInternal() {
    const v = document.getElementById('v');
    const cc = document.getElementById('cmd-center');
    cc.style.display = 'none';
    v.style.display = 'block';
    document.getElementById('ctrl-ui').style.display = 'flex';
    this.proxyIdx = 0;
    this.initHls(v, cc);
  },

  // --- EXTERNAL LAUNCHER (WEB VIDEO CASTER INCLUDED) ---
  launch(type) {
    const url = this.cur;
    if(!url) return;
    
    if (type === 'vlc') {
      window.location.href = `vlc://${url}`;
    } 
    else if (type === 'mx') {
      window.location.href = `intent://${url}#Intent;package=com.mxtech.videoplayer.ad;S.type=video/x-mpegurl;end`;
    } 
    else if (type === 'wvc') {
      // Web Video Caster Intent
      // Package: com.instantbits.cast.webvideo
      // Params: url (stream), title (optional)
      window.location.href = `intent://x#Intent;package=com.instantbits.cast.webvideo;S.url=${encodeURIComponent(url)};S.title=IPLINKS_Stream;end`;
    } 
    else if (type === 'copy') {
      navigator.clipboard.writeText(url);
      alert('Link copiado!');
    }
  },

  x() {
    document.getElementById('m').classList.remove('open');
    document.getElementById('v').pause();
    if (this.hls) this.hls.destroy();
  },

  cpU(u) { navigator.clipboard.writeText(u); alert('Copiado!'); },
  cp() { if(this.cur) this.cpU(this.cur); },
  del(i) { this.d.acc.splice(i,1); this.sv(); this.rndAcc(); },
  rst() { if(confirm('Resetar tudo?')) { this.d = { acc:[], ch:[] }; this.sv(); this.rndAcc(); this.rnd(); }}
};

window.onload = () => V.init();
</script>
</body>
</html>
