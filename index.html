<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>IPLINKS V17.2 UPDATER</title>
  <script src="https://cloudflare.com/cdn-cgi/npm/hls.js@latest"></script>
  <style>
    /* Design Minimalista Profissional */
    :root { --bg: #000; --fg: #e5e5e5; --accent: #0f0; --danger: #ef4444; --card: #111; --border: #333; }
    body { background: var(--bg); color: var(--fg); font-family: 'Consolas', monospace; margin: 0; padding: 10px; }
    
    .container { max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; height: 100vh; }
    
    /* Tabs */
    .nav { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; padding-bottom: 15px; border-style: solid; }
    .btn-nav { background: none; border: none; color: #666; padding: 10px 20px; cursor: pointer; font-family: inherit; font-size: 14px; }
    .btn-nav:hover { color: #fff; }
    .btn-nav.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
    
    /* Cards & Grid */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 10px; overflow-y: auto; flex: 1; padding-bottom: 50px; } /* Espa√ßo para o rodap√© */
    @media (min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
    
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
    
    .c-name { font-weight: bold; font-size: 14px; margin-bottom: 5px; color: #fff; line-height: 1.2; }
    .c-meta { font-size: 11px; color: #888; margin-bottom: 10px; display: flex; justify-content: space-between; }
    
    /* Inputs */
    input, textarea { 
      background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; width: 100%; box-sizing: border-box; font-family: monospace; font-size: 13px; margin-bottom: 10px; 
    }
    input:focus, textarea:focus { outline: none; border-color: var(--accent); }
    
    /* Buttons */
    .btn { background: #222; border: 1px solid var(--border); color: #fff; padding: 10px 15px; border-radius: 4px; cursor: pointer; text-transform: uppercase; font-weight: 600; transition: 0.2s; }
    .btn:hover { background: #333; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #0891f2; border: 0; color: white; width: 100%; }
    .btn-primary:hover { background: #2563eb; }
    
    /* Log Box */
    #log-box { 
      background: #000; border: 1px solid #333; color: #0f0; font-size: 11px; 
      height: 150px; overflow-y: auto; padding: 10px; white-space: pre-wrap; margin-bottom: 10px;
    }

    /* Status Indicator */
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .online { background: #22c55e; }
    .offline { background: #555; }
    
    .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    .badge-new { background: var(--accent); color: #000; }

    /* Modal (Update Logs) */
    #update-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 999; display: none; align-items: center; justify-content: center; padding: 20px; text-align: center; }
    .modal-card { background: #111; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; text-align: center; }
  </style>
</head>
<body>

<div class="container">
  
  <div class="nav">
    <div>
      <h1 style="font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(135deg, #0f0, #0ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">IPLINKS <span style="font-size: 0.7em; color: #fff; font-weight: normal; margin-left: 10px;">V17 UPDATER</span></h1>
    </div>
    
    <div>
      <button class="btn-nav on" onclick="App.show('cfg')">1. CONFIGURA√á√ÉO</button>
      <button class="btn-nav" onclick="App.show('logs')">2. LOGS</button>
    </div>
  </div>

  <!-- ABA CONFIGURA√á√ÉO -->
  <div id="cfg" class="container">
    
    <!-- Config Worker -->
    <div style="margin-bottom: 20px;">
      <div style="display:flex; gap: 10px; align-items: center; background: #111; padding: 10px; border-radius: 4px; border: 1px solid #222; margin-bottom: 10px; justify-content: space-between;">
        <span style="font-weight: bold; color: #aaa;">CONFIGURA√á√ÉO DO WORKER</span>
        <span id="worker-status" class="status-dot"></span>
        <span id="worker-status-text" style="font-size: 10px; color: #555;">DESCONECTADO</span>
      </div>
      <div style="display:flex; gap: 10px;">
        <input type="text" id="wurl" placeholder="URL DO WORKER (Ex: https://worker.seudominio.workers.dev)" class="w-full">
        <button class="btn btn-primary" onclick="App.testWorker()">TESTAR CONEX√ÉO</button>
      </div>

      <!-- Logs Input -->
      <textarea id="logs-input" rows="4" placeholder="Cole seus logs (Suzanor / M3U+) aqui..."></textarea>
      <div class="flex" style="margin-bottom: 10px;">
        <button class="btn" onclick="App.import()">1. IMPORTAR LOGS</button>
        <button class="btn btn-danger" onclick="App.clear()">LIMPAR TUDO</button>
      </div>

      <!-- Contas -->
      <div style="border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 10px;">
        <div style="display:flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: bold; font-size: 0.9rem; color: #fff;">MINHAS CONTAS ATIVAS</span>
          <span id="active-accs-count" class="badge-new">0</span>
        </div>
        <div id="acc-list"></div>
      </div>

      <!-- Action -->
      <div style="display:flex; gap: 10px;">
        <button class="btn btn-primary" onclick="App.updateList()">2. ATUALIZAR LISTA (PROXY)</button>
        <button class="btn" onclick="App.openModal()">‚¨á EXPORTAR</button>
      </div>
      
      <div style="margin-top: 10px; font-size: 11px; color: #555;">
        Dica: Clique em ATUALIZAR LISTA para processar contas e atualizar o KV automaticamente.
      </div>
  </div>

  <!-- ABA LOGS -->
  <div id="logs" style="display: none; height: 100%; display: flex; flex-direction: column; overflow: hidden;">
    <button onclick="document.getElementById('logs').innerHTML=''; location.reload()" style="cursor: pointer; color: #aaa; background: none; text-align: right; font-family: inherit; font-size: 0.8rem;">LIMPAR LOGS</button>
    <div id="log-content" style="flex: 1; overflow-y: auto; padding: 10px;">
      <div style="color: #666; font-family: monospace; white-space: pre-wrap; font-size: 11px;"></div>
    </div>
  </div>

  <!-- PLAYER MODAL -->
  <div id="modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 999; align-items: center; justify-content: center; flex-direction: column; padding: 20px;">
    <div class="modal-card">
      <h2 style="font-size: 1.2rem; margin-bottom: 10px; color: #fff;">ATUALIZANDO...</h2>
      <div id="modal-msg" style="color: #aaa; margin-bottom: 15px; text-align: center; font-size: 0.9rem;">
        Processando contas... Isso pode levar at√© 1 minuto.
      </div>
      <div class="spinner"></div>
    </div>
  </div>

<script>
const App = {
  data: {
    acc: [], // Lista de contas locais
    remoteData: null, // Dados remotos (vindo do Worker)
    workerUrl: '',
    updateUrl: '' // URL para o update manual (opcional)
  },

  init() {
    const saved = localStorage.getItem('iplinks_v17_2');
    if(saved) {
      const parsed = JSON.parse(saved);
      this.data.acc = parsed.acc || [];
      this.workerUrl = parsed.workerUrl || '';
      this.remoteData = parsed.remoteData || null;
      if (this.remoteData) {
        this.data.ch = this.remoteData.channels || [];
        this.renderList();
      }
    }
    
    // Configura URL Worker
    const wUrl = localStorage.getItem('iplinks_worker_url');
    if(wurl) {
      this.workerUrl = wurl;
      document.getElementById('wurl').updateUrl(wurl);
      this.testWorkerConnection();
    }
  },

  save() {
    localStorage.setItem('iplinks_v17_2', JSON.stringify({
      acc: this.data.acc,
      workerUrl: document.getElementById('wurl').value.trim(),
      remoteData: this.remoteData
    }));
    this.renderList();
  },

  // --- UI LOGS ---
  log(msg) {
    const el = document.getElementById('log-content');
    const time = new Date().toLocaleTimeString().split('show_msg')[0];
    el.innerHTML += `[${time}] ${msg}\n`;
    el.scrollTop = el.scrollHeight;
  },

  switchTab(id) {
    document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
    document.getElementById('cfg').style.display = id === 'cfg' ? 'block' : 'none';
    document.getElementById('logs').style.display = id === 'logs' ? 'flex' : 'none';
    document.getElementById(`nav-${id}`).classList.add('active');
  },

  // --- IMPORTA√á√ÉO -->
  import() {
    const txt = document.getElementById('logs-input').value;
    const r = /https?:\/\/([^\/:]+):?(\d+)?\/get\.php\?username=([^&]+)&password=([^&\s]+)/gi;
    let m, c = 0;
    while((m = r.exec(txt)) !== null) {
      const u = `http://${m[3]}:${m[4]}@${m[1]}:${m[2]||80}`;
      if (!this.data.acc.find(x => x.url === u)) {
        this.data.acc.push({
          url: u, h: m[1], p: m[2] || '80', u: m[3], pw: m[4], s: 'Pending' // Estado inicial
        });
        c++;
      }
    }
    
    if (c > 0) {
      document.getElementById('logs-input').value = '';
      this.save();
      this.renderAcc();
      this.log(`${c} contas importadas. Clique em Atualizar Lista.`);
    } else {
      this.log('Nenhum acesso encontrado no texto.', 'error');
    }
  },

  // --- TESTE DO WORKER ---
  async testWorker() {
    if (!this.workerUrl) return alert('Cole a URL do Worker primeiro.');
    
    this.workerUrl = document.getElementById('wurl').value.trim();
    this.log(`Testando: ${this.workerUrl}/health...`);
    
    try {
      const res = await fetch(`${this.workerUrl}/health`);
      const data = await res.json();
      
      const statusInd = document.getElementById('worker-status');
      const statusText = document.getElementById('worker-status-text');
      
      if (data.ok && data.canais > 0) {
        statusInd.className = 'status-dot online';
        statusText.innerText = "ONLINE";
        this.save(); // Salva a URL para n√£o digitar sempre
        this.log(`Worker Online. ${data.canais} canais no KV.`);
      } else {
        statusInd.className = 'status-dot offline';
        statusText = "OFFLINE OU VAZIO";
        this.log(`Worker Status: ${data.canais} canais. KV vazio.`);
      }
    } catch (e) {
      const statusInd = document.getElementById('worker-url').parentElement.querySelector('.status-dot');
      statusInd.className = 'status-dot offline';
      this.log(`Erro Worker: ${e.message}`, 'error');
    }
  },

  // --- ATUALIZA√á√ÉO INTELIGENTE ---
  async updateList() {
    if (!this.workerUrl) return alert('Configurar URL do Worker primeiro.');
    
    const activeAcc = this.data.acc.filter(a => a.s === 'ON' || a.s === 'Pending');
    if (activeAcc.length === 0) return alert('Nenhuma conta online encontrada.');

    // 1. Abre o modal de Loading
    const modal = document.getElementById('modal');
    const msg = document.getElementById('modal-msg');
    const loader = document.querySelector('.spinner');
    modal.style.display = 'flex';
    msg.style.display = 'block';

    try {
      this.log('Enviando contas para o Worker...');
      
      // Envia contas para o Worker (V8 Logic)
      const payload = {
        t: Date.now(),
        accounts: activeAcc.map(a => ({ url: a.url }))
      };
      
      const res = await fetch(`${this.workerUrl}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      
      if(data.error) throw new Error(data.error);

      // Worker retorna channels e streams
      // Precisamos atualizar `this.data` localmente para que o Player HTML mostre os canais
      // E atualizar o KV no Worker (Worker j√° cuida disso)
      
      this.data = data.channels || [];
      
      // Sincroniza o tempo remoto tamb√©m
      this.save();
      
      this.renderList();
      this.log(`Sucesso! ${this.data.length} canais atualizados no Worker.`);
      this.switchTab('list');
      alert('Lista atualizada com sucesso!');
      
    } catch (e) {
      this.log(`Erro na atualiza√ß√£o: ${e.message}`, 'error');
      alert('Falha na conex√£o com o Worker. Verifique a URL e o c√≥digo do Worker.');
    } finally {
      modal.style.display = 'none';
    }
  },

  // --- RENDER ---
  renderList() {
    const list = document.getElementById('channel-grid');
    document.getElementById('active-accs-count').innerText = this.data.length;

    if (this.data.length === 0) {
      list.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Nenhum canal.</div>';
      return;
    }

    // Renderiza Grade
    list.innerHTML = this.data.map(c => `
      <div class="card">
        <div class="c-name">${c.name}</div>
        <div class="c-meta">
          <span style="font-size: 10px; color: #aaa;">${c.id}</span>
          <span style="color: var(--accent);">‚Ä¢ LIVE</span>
        </div>
        <div class="c-meta">
          <span style="margin-right: 10px;">FONTES:</span>
          ${Object.keys(c.streams).length} 
            /* Exibe 'Main' se tiver apenas 1, ou 'Main + 1 backup' se tiver mais */
            .map(k => k.includes('_b1') ? 'Backup' : 'Principal')
            .join(', ')
        </div>
        
        <div class="c-actions">
          <button class="btn btn-primary" onclick="App.play('${c.streams.main}', '${c.name.replace(/'/g, "\\'")}')">PLAY</button>
          <button class="btn" onclick="App.cast('wvc', '${c.streams.main}')">üì∫ CAST</button>
        </div>
      </div>
    `).join('');
  },

  // --- PLAYERS ---
  play(url, title) {
    const wurl = document.getElementById('wurl').value.trim();
    // Se tiver Worker configurado, usa Proxy do Worker. Se n√£o, tenta direto.
    const target = wurl ? `${wurl}/proxy?url=${encodeURIComponent(url)}` : url;
    window.open(target, '_blank');
  },

  cast(app, url) {
    if (!url) return alert('Selecione um canal primeiro.');
    if (app === 'wvc') {
      window.location.href = `intent://x#Intent;package=com.instantbits.cast.webvideo;S.url=${encodeURIComponent(url)};end`;
    } else if (app === 'vlc') {
      window.location.href = `vlc://${url}`;
    }
  },

  clear() {
    this.data = [];
    this.save();
    this.renderList();
    this.log('Lista limpa.');
  },

  openModal() {
    const el = document.getElementById('modal');
    el.style.display = 'none'; // Esconde primeiro
    el.style.display = 'flex'; // Depois mostra
  }
};

window.onload = () => App.init();
</script>
</body>
</html>
