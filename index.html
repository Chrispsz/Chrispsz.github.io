<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPLINKS V3 CORE</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root { --bg: #000; --fg: #0f0; --dim: #333; --input: #111; }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Consolas', monospace; }
    body { background: var(--bg); color: #ccc; font-size: 12px; }
    
    /* LAYOUT */
    .c { max-width: 900px; margin: 0 auto; padding: 20px; }
    .hd { display: flex; justify-content: space-between; border-bottom: 1px solid var(--dim); padding-bottom: 10px; margin-bottom: 20px; }
    h1 { color: var(--fg); font-size: 20px; letter-spacing: -1px; }
    
    /* NAV */
    nav button { background: none; border: none; color: #555; cursor: pointer; padding: 5px 10px; text-transform: uppercase; font-weight: bold; }
    nav button.on { color: var(--fg); border-bottom: 1px solid var(--fg); }

    /* UI ELEMENTS */
    .btn { background: var(--input); border: 1px solid var(--dim); color: #fff; cursor: pointer; padding: 8px 12px; font-family: inherit; font-size: 11px; text-transform: uppercase; }
    .btn:hover { border-color: var(--fg); color: var(--fg); }
    .btn:active { background: var(--fg); color: #000; }
    .btn.primary { border-color: var(--fg); color: var(--fg); }
    
    input, textarea, select { background: var(--input); border: 1px solid var(--dim); color: var(--fg); padding: 10px; width: 100%; font-family: inherit; margin-bottom: 10px; }
    textarea { height: 80px; font-size: 11px; resize: vertical; }
    
    /* LISTS */
    .list { border-top: 1px solid var(--dim); }
    .row { border-bottom: 1px solid var(--dim); padding: 8px; display: flex; justify-content: space-between; align-items: center; }
    .row:hover { background: #050505; }
    .ok { color: var(--fg); } .err { color: #555; } .dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; display: inline-block; margin-right: 8px; }
    
    /* GRID */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 5px; }
    .card { border: 1px solid var(--dim); padding: 10px; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; }
    .card:hover { border-color: var(--fg); }
    .c-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; color: #fff; }
    .c-meta { font-size: 10px; color: #555; margin-bottom: 8px; }
    .c-act { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    
    /* MODAL */
    #m { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 99; display: none; align-items: center; justify-content: center; }
    #m.open { display: flex; }
    #v { width: 100%; max-width: 900px; aspect-ratio: 16/9; background: #000; }
    .ctrl { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }

    /* UTILS */
    .hidden { display: none !important; }
    .w-full { width: 100%; }
    .flex { display: flex; gap: 10px; }
    .mt-1 { margin-top: 10px; }
  </style>
</head>
<body>

<div class="c">
  <div class="hd">
    <h1>IPLINKS<span style="font-size:0.5em; vertical-align:top; opacity:0.5">v3</span></h1>
    <nav>
      <button id="b-cfg" class="on" onclick="V.go('cfg')">CONFIG</button>
      <button id="b-lst" onclick="V.go('lst')">LIST</button>
    </nav>
  </div>

  <!-- CONFIG -->
  <div id="cfg">
    <textarea id="in" placeholder="PASTE LOGS HERE (SUZANOR / M3U LINKS)"></textarea>
    <button class="btn primary w-full" onclick="V.imp()">IMPORT & EXTRACT</button>
    
    <div class="mt-1 flex">
      <button class="btn" onclick="V.chk()">CHECK (AUTO-PROXY)</button>
      <button class="btn primary" onclick="V.load()">LOAD CHANNELS</button>
      <button class="btn" style="color:red" onclick="V.rst()">RESET</button>
    </div>

    <div class="list" id="acc"></div>
    
    <div class="mt-1" style="padding-top:10px; border-top:1px dashed #333">
      <div style="color:#555; margin-bottom:5px;">CLOUDFLARE KV (OPT)</div>
      <div class="flex">
        <input type="password" id="kv-t" placeholder="TOKEN" style="margin:0">
        <input type="text" id="kv-a" placeholder="ACC ID" style="margin:0">
        <input type="text" id="kv-n" placeholder="NS ID" style="margin:0">
      </div>
      <button class="btn w-full mt-1" onclick="V.sync()">SYNC TO KV</button>
    </div>
  </div>

  <!-- LIST -->
  <div id="lst" class="hidden">
    <div class="flex">
      <input type="text" id="s" placeholder="FILTER..." onkeyup="V.rnd()" style="margin:0">
      <select id="f-q" onchange="V.rnd()" style="width:80px; margin:0">
        <option value="all">ALL</option>
        <option value="hd">HD</option>
        <option value="sd">SD</option>
      </select>
    </div>
    <div class="grid mt-1" id="g"></div>
  </div>
</div>

<!-- PLAYER -->
<div id="m">
  <div style="position:relative; width:100%; max-width:900px;">
    <video id="v" controls autoplay></video>
    <div class="ctrl">
      <button class="btn" onclick="V.cp()">COPY URL</button>
      <button class="btn" onclick="V.x()">CLOSE</button>
    </div>
  </div>
</div>

<script>
// --- CORE ENGINE ---
const V = {
  d: { acc: [], ch: [] }, // Data
  hls: null,
  cur: '',
  // PROXY CONFIG: Automaticamente usa proxy se estiver em HTTPS (ex: GitHub Pages)
  useProxy: location.protocol === 'https:',
  proxyUrl: 'https://api.allorigins.win/raw?url=', 

  init() {
    const s = localStorage.getItem('iplinks_v3');
    if (s) this.d = JSON.parse(s);
    const k = JSON.parse(localStorage.getItem('iplinks_kv') || '{}');
    if(k.t) document.getElementById('kv-t').value = k.t;
    if(k.a) document.getElementById('kv-a').value = k.a;
    if(k.n) document.getElementById('kv-n').value = k.n;
    this.rndAcc();
  },

  sv() {
    localStorage.setItem('iplinks_v3', JSON.stringify(this.d));
    localStorage.setItem('iplinks_kv', JSON.stringify({
      t: document.getElementById('kv-t').value,
      a: document.getElementById('kv-a').value,
      n: document.getElementById('kv-n').value
    }));
  },

  go(x) {
    document.getElementById('cfg').classList.toggle('hidden', x !== 'cfg');
    document.getElementById('lst').classList.toggle('hidden', x !== 'lst');
    document.getElementById('b-cfg').classList.toggle('on', x === 'cfg');
    document.getElementById('b-lst').classList.toggle('on', x === 'lst');
    if (x === 'lst') this.rnd();
  },

  msg(t) {
    const m = document.createElement('div');
    m.style.cssText = "position:fixed; bottom:20px; right:20px; background:#0f0; color:#000; padding:10px 20px; z-index:999; font-weight:bold;";
    m.innerText = t;
    document.body.appendChild(m);
    setTimeout(() => m.remove(), 2000);
  },

  // --- SMART FETCH (Handles CORS/HTTPS) ---
  async fetchRaw(url) {
    try {
      if (this.useProxy) {
        // Encode URL para o proxy
        const res = await fetch(this.proxyUrl + encodeURIComponent(url));
        if (!res.ok) throw new Error('Proxy Fail');
        return await res.json();
      } else {
        const res = await fetch(url);
        return await res.json();
      }
    } catch (e) {
      console.warn("Fetch failed", e);
      return null;
    }
  },

  // --- IMPORT ---
  imp() {
    const txt = document.getElementById('in').value;
    if (!txt.trim()) return this.msg('INPUT EMPTY');
    let c = 0;

    // Regex M3U Get (Suzanor style)
    const re = /https?:\/\/([^\/:]+)(?::(\d+))?\/get\.php\?username=([^&]+)&password=([^&\s]+)/gi;
    let m;
    while ((m = re.exec(txt)) !== null) {
      const u = `http://${m[3]}:${m[4]}@${m[1]}:${m[2]||80}`;
      if (!this.d.acc.find(x => x.url === u)) {
        this.d.acc.push({ id: Date.now()+Math.random(), url: u, h: m[1], p: m[2]||80, u: m[3], pw: m[4], s: '?' });
        c++;
      }
    }
    
    if (c > 0) {
      document.getElementById('in').value = '';
      this.sv();
      this.rndAcc();
      this.chk(); // Auto check
      this.msg(`+${c} ACCOUNTS`);
    } else {
      this.msg('NO ACCESS FOUND');
    }
  },

  // --- CHECK ---
  async chk() {
    if (this.d.acc.length === 0) return;
    this.msg('CHECKING (PROXY: '+this.useProxy+')...');
    
    for (let a of this.d.acc) {
      a.s = '..';
      this.rndAcc();
      const url = `http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}`;
      const data = await this.fetchRaw(url);
      a.s = (data && data.user_info && data.user_info.status === 'Active') ? 'ON' : 'OFF';
    }
    this.sv();
    this.rndAcc();
  },

  // --- LOAD ---
  async load() {
    const valid = this.d.acc.filter(a => a.s === 'ON');
    // Fallback: Se nenhum ON, tenta carregar de todos (Ãºtil se check falhou por proxy lento)
    const target = valid.length ? valid : this.d.acc; 
    
    if (!target.length) return this.msg('NO ACCOUNTS');
    this.msg('LOADING...');
    this.d.ch = [];
    
    const keys = ['PREMIERE', 'ESPN', 'SPORTV', 'AMAZON', 'PRIME', 'HBO', 'DAZN', 'TNT'];

    for (const a of target) {
      const url = `http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}&action=get_live_streams`;
      const data = await this.fetchRaw(url);
      if (Array.isArray(data)) {
        data.forEach(x => {
          const n = x.name.toUpperCase();
          if (keys.some(k => n.includes(k))) {
            this.d.ch.push({
              n: x.name,
              u: `http://${a.h}:${a.p}/live/${a.u}/${a.pw}/${x.stream_id}.m3u8`,
              q: n.includes('4K')?'4K':(n.includes('HD')?'HD':'SD')
            });
          }
        });
      }
    }
    this.sv();
    this.go('lst');
    this.msg(`${this.d.ch.length} CH`);
  },

  // --- RENDER ---
  rndAcc() {
    document.getElementById('acc').innerHTML = this.d.acc.map((a, i) => `
      <div class="row">
        <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          <span class="dot" style="color:${a.s==='ON'?'#0f0':'#555'}"></span>
          <span style="color:#555">[${a.h}]</span> ${a.u}
        </div>
        <button class="btn" style="color:red; padding:2px 5px;" onclick="V.del(${i})">X</button>
      </div>
    `).join('') || '<div style="padding:10px; color:#333; text-align:center">NO DATA</div>';
  },

  rnd() {
    const q = document.getElementById('s').value.toUpperCase();
    const fq = document.getElementById('f-q').value;
    const el = document.getElementById('g');
    
    const flt = this.d.ch.filter(c => {
      const ok = c.n.toUpperCase().includes(q);
      const okQ = fq === 'all' || c.q === fq.toUpperCase();
      return ok && okQ;
    });

    el.innerHTML = flt.map(c => `
      <div class="card">
        <div>
          <div class="c-name">${c.n}</div>
          <div class="c-meta" style="color:${c.q==='HD'?'#0f0':'#555'}">${c.q}</div>
        </div>
        <div class="c-act">
          <button class="btn primary" onclick="V.pl('${encodeURIComponent(c.u)}','${c.n.replace(/'/g,"\\'")}')">PLAY</button>
          <button class="btn" onclick="V.cpU('${c.u}')">LINK</button>
        </div>
      </div>
    `).join('') || '<div style="grid-column:1/-1; text-align:center; color:#333; padding:20px">EMPTY</div>';
  },

  // --- PLAYER ---
  pl(url, name) {
    this.cur = decodeURIComponent(url);
    const v = document.getElementById('v');
    const m = document.getElementById('m');
    m.classList.add('open');
    
    if (this.hls) this.hls.destroy();
    
    if (Hls.isSupported()) {
      this.hls = new Hls({ enableWorker: true });
      this.hls.loadSource(this.cur);
      this.hls.attachMedia(v);
      this.hls.on(Hls.Events.MANIFEST_PARSED, () => v.play().catch(()=>{}));
    } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
      v.src = this.cur;
      v.play().catch(()=>{});
    }
  },

  x() {
    document.getElementById('m').classList.remove('open');
    document.getElementById('v').pause();
    if (this.hls) this.hls.destroy();
  },

  cpU(u) { navigator.clipboard.writeText(u); this.msg('COPIED'); },
  cp() { if(this.cur) this.cpU(this.cur); },
  del(i) { this.d.acc.splice(i,1); this.sv(); this.rndAcc(); },
  rst() { if(confirm('RESET?')) { this.d = { acc:[], ch:[] }; this.sv(); this.rndAcc(); this.rnd(); }},

  // --- SYNC ---
  async sync() {
    const t = document.getElementById('kv-t').value;
    const a = document.getElementById('kv-a').value;
    const n = document.getElementById('kv-n').value;
    if(!t || !a || !n) return this.msg('MISSING KV CREDS');
    
    this.msg('SYNCING...');
    try {
      await fetch(`https://api.cloudflare.com/client/v4/accounts/${a}/storage/kv/namespaces/${n}/values/iplinks_core`, {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ t: Date.now(), d: this.d.ch })
      });
      this.msg('SYNC OK');
    } catch(e) { this.msg('SYNC ERR'); }
  }
};

window.onload = () => V.init();
</script>
</body>
</html>
