<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IPLINKS V11 MANUAL</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { background: #000; color: #ddd; font-family: sans-serif; margin: 0; padding: 10px; font-size: 14px; }
    
    /* UI */
    .box { max-width: 800px; margin: 0 auto; }
    .btn { background: #222; color: #fff; border: 1px solid #444; padding: 12px; width: 100%; margin-bottom: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
    .btn:active { background: #444; }
    .btn-green { background: #006622; border-color: #006622; color: #fff; }
    .btn-red { background: #880000; border-color: #880000; color: #fff; }
    
    input, textarea { background: #111; border: 1px solid #333; color: #fff; padding: 10px; width: 100%; margin-bottom: 10px; border-radius: 4px; box-sizing: border-box; font-family: monospace; }
    
    /* TABS */
    .tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #333; }
    .tab { flex: 1; padding: 10px; text-align: center; background: #111; cursor: pointer; border: 1px solid #333; border-bottom: none; margin-bottom: -1px; }
    .tab.active { background: #000; border-bottom: 1px solid #000; color: #0f0; }

    /* LISTS */
    .item { padding: 10px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
    .item span { word-break: break-all; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 8px; }
    @media (min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
    
    .card { background: #111; padding: 10px; border: 1px solid #333; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; }
    .c-name { font-weight: bold; margin-bottom: 5px; color: #eee; }
    .c-meta { font-size: 11px; color: #888; margin-bottom: 8px; }
    .c-btns { display: flex; gap: 5px; }
    .c-btns button { flex: 1; padding: 8px; font-size: 12px; }

    /* LOGS */
    #logs { background: #080808; color: #0f0; font-family: monospace; padding: 10px; height: 150px; overflow-y: auto; border: 1px solid #333; font-size: 11px; margin-top: 10px; white-space: pre-wrap; }

    /* MODAL */
    #player-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: none; flex-direction: column; }
    #player-modal.open { display: flex; }
    video { width: 100%; height: 100%; background: #000; }
    .p-controls { padding: 10px; display: flex; gap: 10px; background: #111; }

    /* EXTERNAL MENU */
    #ext-menu { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .ext-btn { width: 100%; max-width: 300px; margin-bottom: 10px; padding: 15px; background: #222; border: 1px solid #555; color: #fff; text-align: left; font-size: 14px; display: flex; align-items: center; gap: 10px; }

    .hidden { display: none !important; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .on { background: #0f0; } .off { background: #f00; } .warn { background: #ffaa00; }
    
    /* PROXY TOGGLE */
    .proxy-box { background: #1a1a1a; border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
    .proxy-label { display: flex; align-items: center; gap: 10px; font-weight: bold; color: #ffaa00; cursor: pointer; }
  </style>
</head>
<body>

<div class="box">
  <h1 style="text-align: center; margin-bottom: 10px;">IPLINKS <span style="color:#0f0">V11</span></h1>
  
  <div class="tabs">
    <div class="tab active" onclick="App.show('config')">CONFIG</div>
    <div class="tab" onclick="App.show('list')">LISTA (<span id="count">0</span>)</div>
    <div class="tab" onclick="App.show('logs')">LOGS</div>
  </div>

  <!-- CONFIG -->
  <div id="config">
    <!-- PROXY CONTROL (NEW) -->
    <div class="proxy-box">
      <label class="proxy-label">
        <input type="checkbox" id="use-proxy" onchange="App.toggleProxy()">
        <span>USAR PROXY (Para GitHub/HTTPS)</span>
      </label>
      <div style="font-size:10px; color:#666; margin-top:5px; margin-left:24px;">
        Se estiver rodando localmente, DESMARQUE isso para evitar bloqueio 403.
      </div>
    </div>

    <textarea id="input-logs" rows="4" placeholder="Cole aqui (Suzanor / M3U)..."></textarea>
    <button class="btn btn-green" onclick="App.import()">1. IMPORTAR LOGS</button>
    
    <div style="margin-top: 10px;">
      <button class="btn" onclick="App.check()">2. VERIFICAR CONTAS</button>
      <button class="btn btn-red" onclick="App.reset()">RESET</button>
    </div>

    <div id="acc-list" style="margin-top: 10px; border: 1px solid #333;"></div>

    <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
      <label><input type="checkbox" id="force-load"> FORÃ‡AR TODOS (IGNORAR FILTRO)</label>
      <button class="btn btn-green" style="margin-top: 5px;" onclick="App.loadChannels()">3. CARREGAR CANAIS</button>
    </div>
  </div>

  <!-- LISTA -->
  <div id="list" class="hidden">
    <input type="text" id="search" placeholder="Buscar..." onkeyup="App.renderList()">
    <div id="channel-grid" class="grid"></div>
  </div>

  <!-- LOGS -->
  <div id="logs-tab" class="hidden">
    <button class="btn" onclick="document.getElementById('logs').innerHTML=''">LIMPAR LOGS</button>
    <div id="logs"></div>
  </div>
</div>

<!-- PLAYER -->
<div id="player-modal">
  <video id="video" controls playsinline></video>
  <div class="p-controls" id="p-ctrl">
    <button class="btn" style="flex:1" onclick="App.copyUrl()">COPIAR LINK</button>
    <button class="btn btn-red" style="flex:1" onclick="App.closePlayer()">FECHAR</button>
  </div>

  <!-- MENU EXTERNO -->
  <div id="ext-menu">
    <h2 style="color:#f00; margin-bottom: 20px;">STREAM BLOQUEADO</h2>
    
    <button class="ext-btn" onclick="App.cast('vlc')">ðŸ¦† VLC Player</button>
    <button class="ext-btn" onclick="App.cast('mx')">ðŸ¤– MX Player</button>
    <button class="ext-btn" onclick="App.cast('wvc')">ðŸ“¡ Web Video Caster</button>
    <button class="ext-btn" onclick="App.cast('copy')">ðŸ“‹ Copiar URL</button>
    
    <button class="btn" style="margin-top: 20px; background: transparent; border: 1px solid #555;" onclick="App.retry()">Tentar Novamente</button>
  </div>
</div>

<script>
const App = {
  data: { acc: [], ch: [] },
  hls: null,
  curUrl: '',
  // Proxy Chain
  proxies: [
    'https://api.allorigins.win/raw?url=', 
    'https://corsproxy.io/?'
  ],
  // State
  useProxyMode: false,

  init() {
    // Detecta protocolo para sugerir uso de proxy
    const isHttps = location.protocol === 'https:';
    this.useProxyMode = isHttps; 
    
    // Carrega preferÃªncia salva se existir
    const savedProxy = localStorage.getItem('iplinks_use_proxy');
    if(savedProxy !== null) {
      this.useProxyMode = (savedProxy === 'true');
    }

    // Atualiza UI
    document.getElementById('use-proxy').checked = this.useProxyMode;
    
    this.log(`SISTEMA V11 INIT - Proxy: ${this.useProxyMode ? 'ON' : 'OFF'}`);
    
    const s = localStorage.getItem('iplinks_v11');
    if(s) this.data = JSON.parse(s);
    this.renderAcc();
  },

  toggleProxy() {
    this.useProxyMode = document.getElementById('use-proxy').checked;
    localStorage.setItem('iplinks_use_proxy', this.useProxyMode);
    this.log(`Modo Proxy alterado para: ${this.useProxyMode ? 'ON' : 'OFF'}`, 'warn');
  },

  save() { localStorage.setItem('iplinks_v11', JSON.stringify(this.data)); },
  
  log(msg, type='info') {
    const div = document.getElementById('logs');
    const t = new Date().toLocaleTimeString();
    const color = type === 'err' ? '#f00' : (type === 'warn' ? '#ffaa00' : '#0f0');
    div.innerHTML += `<div style="color:${color}">[${t}] ${msg}</div>`;
    div.scrollTop = div.scrollHeight;
  },

  show(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#config, #list, #logs-tab').forEach(d => d.classList.add('hidden'));
    
    if(tab === 'config') {
      document.getElementById('config').classList.remove('hidden');
      document.querySelectorAll('.tab')[0].classList.add('active');
    } else if(tab === 'list') {
      document.getElementById('list').classList.remove('hidden');
      document.querySelectorAll('.tab')[1].classList.add('active');
      this.renderList();
    } else if(tab === 'logs') {
      document.getElementById('logs-tab').classList.remove('hidden');
      document.querySelectorAll('.tab')[2].classList.add('active');
    }
  },

  // --- CORE ---
  import() {
    const txt = document.getElementById('input-logs').value;
    if(!txt.trim()) return alert('Cole os logs!');
    
    const re = /https?:\/\/([^\/:]+)(?::(\d+))?\/get\.php\?username=([^&]+)&password=([^&\s]+)/gi;
    let c = 0;
    let m;
    while((m = re.exec(txt)) !== null) {
      const u = `http://${m[3]}:${m[4]}@${m[1]}:${m[2]||80}`;
      if(!this.data.acc.find(x => x.url === u)) {
        this.data.acc.push({ 
          url: u, h: m[1], p: m[2]||80, u: m[3], pw: m[4], s: '?' 
        });
        c++;
      }
    }
    if(c > 0) {
      document.getElementById('input-logs').value = '';
      this.save();
      this.renderAcc();
      this.log(`Importadas ${c} contas.`);
      this.check();
    } else {
      alert('Nenhuma conta encontrada.');
    }
  },

  async check() {
    for(let a of this.data.acc) {
      a.s = '..';
      this.renderAcc();
      try {
        const url = `http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}`;
        const finalUrl = this.useProxyMode ? (this.proxies[0] + encodeURIComponent(url)) : url;
        
        this.log(`Check ${a.h} via ${this.useProxyMode ? 'Proxy' : 'Direto'}`);
        const res = await fetch(finalUrl);
        if(!res.ok) throw new Error(`Status ${res.status}`);
        
        const j = await res.json();
        a.s = (j.user_info && j.user_info.status === 'Active') ? 'ON' : 'OFF';
        this.log(`Check ${a.h}: ${a.s}`);
      } catch(e) {
        a.s = 'OFF';
        this.log(`Erro check ${a.h}: ${e.message}`, 'err');
      }
    }
    this.save();
    this.renderAcc();
  },

  // --- LOAD CHANNELS (WITH MANUAL PROXY SWITCH) ---
  async loadChannels() {
    const valid = this.data.acc.filter(a => a.s === 'ON');
    const target = valid.length ? valid : this.data.acc;
    if(!target.length) return alert('Sem contas online!');
    
    this.data.ch = [];
    this.log(`Iniciando carregamento (Proxy: ${this.useProxyMode ? 'ON' : 'OFF'})...`, 'warn');
    
    const force = document.getElementById('force-load').checked;
    const keys = ['PREMIERE', 'ESPN', 'SPORTV', 'AMAZON', 'PRIME', 'HBO', 'DAZN', 'TNT'];

    // Helper de fetch ajustado
    const fetchList = async (host, port, user, pass) => {
      const url = `http://${host}:${port}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
      
      // Se nÃ£o usar proxy, tenta direto
      if (!this.useProxyMode) {
        try {
          this.log(`Tentando direto (sem proxy)...`);
          const res = await fetch(url);
          if(!res.ok) throw new Error(`Status ${res.status}`);
          const text = await res.text();
          this.log(`Baixado ${Math.round(text.length/1024)}KB direto.`);
          if(text.trim().startsWith('<')) throw new Error('Resposta HTML (Erro)');
          return JSON.parse(text);
        } catch(e) {
          this.log(`Falha direto: ${e.message}`, 'err');
          return null;
        }
      } 
      // Se usar proxy, tenta a rotaÃ§Ã£o
      else {
        for(let i=0; i < this.proxies.length; i++) {
          try {
            this.log(`Tentando Proxy ${i+1}...`);
            const res = await fetch(this.proxies[i] + encodeURIComponent(url));
            if(!res.ok) throw new Error(`Status ${res.status}`);
            const text = await res.text();
            this.log(`Baixado ${Math.round(text.length/1024)}KB via Proxy ${i+1}.`);
            if(text.trim().startsWith('<')) throw new Error('Resposta HTML (Erro)');
            return JSON.parse(text);
          } catch(e) {
            this.log(`Falha Proxy ${i+1}: ${e.message}`, 'err');
          }
        }
      }
      return null;
    };

    for(const a of target) {
      const data = await fetchList(a.h, a.p, a.u, a.pw);
      
      if(data && Array.isArray(data)) {
        this.log(`Sucesso! ${data.length} canais brutos.`);
        let added = 0;
        
        data.forEach(x => {
          const n = x.name.toUpperCase();
          const isTarget = force ? true : keys.some(k => n.includes(k));
          if(isTarget) {
            this.data.ch.push({
              n: x.name,
              u: `http://${a.h}:${a.p}/live/${a.u}/${a.pw}/${x.stream_id}.m3u8`,
              q: n.includes('4K')?'4K':(n.includes('HD')?'HD':'SD')
            });
            added++;
          }
        });
        this.log(`Filtrados: +${added} canais.`);
      } else {
        this.log(`Falha total em ${a.h}`, 'err');
      }
    }
    
    this.save();
    this.show('list');
    this.log(`Finalizado. Total: ${this.data.ch.length}`, 'warn');
  },

  // --- RENDER ---
  renderAcc() {
    const el = document.getElementById('acc-list');
    el.innerHTML = this.data.acc.map((a, i) => `
      <div class="item">
        <div><span class="status-dot ${a.s==='ON'?'on':'off'}"></span> ${a.h}</div>
        <button onclick="App.del(${i})" style="background:none;border:none;color:red;cursor:pointer;">X</button>
      </div>
    `).join('') || '<div style="padding:10px;color:#555">Vazio</div>';
  },

  renderList() {
    const q = document.getElementById('search').value.toUpperCase();
    const el = document.getElementById('channel-grid');
    document.getElementById('count').innerText = this.data.ch.length;

    const flt = this.data.ch.filter(c => c.n.toUpperCase().includes(q));
    
    el.innerHTML = flt.map(c => `
      <div class="card">
        <div>
          <div class="c-name">${c.n}</div>
          <div class="c-meta" style="color:${c.q==='HD'?'#0f0':'#888'}">${c.q}</div>
        </div>
        <div class="c-btns">
          <button class="btn btn-green" style="font-size:10px;padding:5px;" onclick="App.play('${encodeURIComponent(c.u)}','${c.n.replace(/'/g,"\\'")}')">PLAY</button>
          <button class="btn" style="font-size:10px;padding:5px;" onclick="App.copyUrl('${c.u}')">LINK</button>
        </div>
      </div>
    `).join('') || '<div style="padding:20px;text-align:center">Nenhum canal</div>';
  },

  // --- PLAYER ---
  play(url, name) {
    this.curUrl = decodeURIComponent(url);
    this.pIdx = 0;
    const v = document.getElementById('video');
    const modal = document.getElementById('player-modal');
    const menu = document.getElementById('ext-menu');
    const ctrl = document.getElementById('p-ctrl');
    
    modal.classList.add('open');
    menu.style.display = 'none';
    ctrl.style.display = 'flex';
    v.style.display = 'block';
    
    this.log(`Play: ${name}`);
    this.initHls(v, menu);
  },

  initHls(video, menu) {
    if(this.hls) this.hls.destroy();
    
    if(Hls.isSupported()) {
      this.hls = new Hls({ 
        enableWorker: true,
        xhrSetup: (xhr, reqUrl) => {
          if(this.useProxyMode) {
            xhr.open('GET', this.proxies[this.pIdx] + encodeURIComponent(reqUrl), true);
          } else {
            xhr.open('GET', reqUrl, true);
          }
        }
      });
      
      this.hls.loadSource(this.curUrl);
      this.hls.attachMedia(video);
      this.hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
      
      this.hls.on(Hls.Events.ERROR, (e, d) => {
        if(d.fatal) {
          this.log(`HLS Erro: ${d.type}`);
          if(this.pIdx < this.proxies.length - 1 && this.useProxyMode) {
            this.pIdx++;
            this.hls.destroy();
            this.initHls(video, menu);
          } else {
            video.pause();
            video.style.display = 'none';
            document.getElementById('p-ctrl').style.display = 'none';
            menu.style.display = 'flex';
          }
        }
      });
    } else {
      video.src = this.curUrl;
      video.play();
    }
  },

  retry() {
    const v = document.getElementById('video');
    const m = document.getElementById('ext-menu');
    m.style.display = 'none';
    v.style.display = 'block';
    document.getElementById('p-ctrl').style.display = 'flex';
    this.pIdx = 0;
    this.initHls(v, m);
  },

  cast(type) {
    const u = this.curUrl;
    if(!u) return;
    if(type === 'vlc') window.location.href = `vlc://${u}`;
    if(type === 'mx') window.location.href = `intent://${u}#Intent;package=com.mxtech.videoplayer.ad;S.type=video/x-mpegurl;end`;
    if(type === 'wvc') window.location.href = `intent://x#Intent;package=com.instantbits.cast.webvideo;S.url=${encodeURIComponent(u)};end`;
    if(type === 'copy') { navigator.clipboard.writeText(u); alert('Copiado!'); }
  },

  closePlayer() {
    document.getElementById('player-modal').classList.remove('open');
    document.getElementById('video').pause();
    if(this.hls) this.hls.destroy();
  },

  copyUrl(u) {
    const url = u || this.curUrl;
    if(url) { navigator.clipboard.writeText(url); alert('Link copiado!'); }
  },

  del(i) { this.data.acc.splice(i,1); this.save(); this.renderAcc(); },
  reset() { if(confirm('Resetar?')) { this.data = {acc:[], ch:[]}; this.save(); this.renderAcc(); this.renderList(); }}
};

window.onload = () => App.init();
</script>
</body>
</html>
