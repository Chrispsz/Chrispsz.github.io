<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° IPTV Vasco 2025/2026 - Recovery Mode</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; color: #fff; min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    header { background: #18181b; border-bottom: 1px solid #27272a; padding: 20px; position: sticky; top: 0; z-index: 100; }
    h1 { font-size: 24px; background: linear-gradient(135deg, #a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
    
    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-top: 15px; }
    .tab { padding: 10px 20px; background: #27272a; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .tab:hover { background: #3f3f46; }
    .tab.active { background: #a855f7; }
    
    /* Sections */
    .section { display: none; animation: fadeIn 0.3s; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .card { background: #18181b; border: 1px solid #27272a; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    .card h2 { font-size: 18px; margin: 0 0 15px 0; }
    
    /* Forms */
    textarea, input { width: 100%; padding: 12px; background: #000; border: 1px solid #3f3f46; border-radius: 6px; color: #fff; font-family: monospace; font-size: 13px; margin-bottom: 10px; }
    textarea { resize: vertical; min-height: 100px; }
    
    /* Buttons */
    .btn { padding: 12px 24px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px; }
    .btn-primary { background: #a855f7; color: #fff; }
    .btn-primary:hover { background: #9333ea; }
    .btn-success { background: #22c55e; color: #fff; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #27272a; color: #fff; }
    .btn-secondary:hover { background: #3f3f46; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    
    /* Accounts List */
    .account-item { background: #000; border: 1px solid #272a2a; border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .account-info { flex: 1; min-width: 200px; }
    .account-name { font-weight: 600; font-size: 14px; }
    .account-host { font-size: 11px; color: #71717a; font-family: monospace; }
    .account-actions { display: flex; gap: 8px; }
    
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .status-online { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
    .status-offline { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
    .status-checking { background: #facc15; box-shadow: 0 0 8px #facc15; }
    
    /* Channels Grid */
    .search-bar { position: sticky; top: 100px; z-index: 50; background: #18181b; border: 1px solid #27272a; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    .search-bar input { margin: 0; }
    
    .channels-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
    
    .channel-card { background: #18181b; border: 1px solid #27272a; border-radius: 8px; padding: 15px; transition: all 0.2s; position: relative; }
    .channel-card:hover { border-color: #a855f7; box-shadow: 0 0 20px rgba(168, 85, 247, 0.2); }
    
    .channel-category { font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
    .cat-premiere { color: #22c55e; }
    .cat-amazon { color: #3b82f6; }
    .cat-espn { color: #ef4444; }
    .cat-sportv { color: #a855f7; }
    .cat-outros { color: #71717a; }
    
    .channel-name { font-weight: 600; font-size: 14px; margin-bottom: 12px; line-height: 1.3; }
    
    .channel-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .channel-actions .btn { padding: 8px 12px; font-size: 12px; }
    
    /* Player Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; padding: 20px; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    
    .modal-content { background: #18181b; border: 1px solid #27272a; border-radius: 12px; max-width: 1200px; width: 100%; overflow: hidden; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #27272a; display: flex; justify-content: space-between; align-items: center; background: #000; }
    .modal-header h3 { font-size: 16px; font-weight: 600; }
    .modal-body { background: #000; aspect-ratio: 16/9; position: relative; }
    #player { width: 100%; height: 100%; background: #000; }
    
    .player-error { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: #000; padding: 20px; text-align: center; }
    .player-error.active { display: flex; }
    .player-error h4 { color: #ef4444; margin-bottom: 10px; }
    .player-error p { color: #71717a; margin-bottom: 20px; font-size: 14px; }
    
    .player-loading { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: #000; flex-direction: column; }
    .player-loading.active { display: flex; }
    .spinner { width: 50px; height: 50px; border: 4px solid #27272a; border-top-color: #a855f7; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Notification */
    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #18181b; border: 1px solid #27272a; border-radius: 8px; padding: 15px 20px; z-index: 2000; display: none; animation: slideDown 0.3s; max-width: 90%; }
    .notification.active { display: block; }
    @keyframes slideDown { from { transform: translate(-50%, -100%); } to { transform: translate(-50%, 0); } }
    
    /* Responsive */
    @media (max-width: 768px) {
      .channels-grid { grid-template-columns: 1fr; }
      .btn-group { flex-direction: column; }
      .btn-group .btn { width: 100%; }
      .account-item { flex-direction: column; align-items: flex-start; }
      .account-actions { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="notification" id="notification"></div>

  <header>
    <div class="container">
      <h1>‚ö° IPTV Vasco 2025/2026</h1>
      <p style="color: #71717a; margin-bottom: 0;">PREMIERE ‚Ä¢ AMAZON PRIME ‚Ä¢ ESPN ‚Ä¢ SPORTV</p>
      <div class="tabs">
        <button class="tab active" onclick="switchTab('config')">‚öôÔ∏è Configura√ß√µes</button>
        <button class="tab" onclick="switchTab('channels')">üì∫ Canais (<span id="channel-count">0</span>)</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- CONFIG TAB -->
    <div id="tab-config" class="section active">
      <div class="card">
        <h2>üì• Importar Acessos</h2>
        <textarea id="import-text" placeholder="Cole os logs aqui..."></textarea>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="importAccounts()">üîç Extrair Acessos</button>
          <button class="btn btn-secondary" onclick="document.getElementById('import-text').value = ''">Limpar</button>
        </div>
        <p style="font-size: 12px; color: #71717a; margin-top: 5px;">
          <strong>Nota:</strong> Se n√£o estiver encontrando canais, use a fun√ß√£o de diagn√≥stico abaixo.
        </p>
      </div>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
          <h2 style="margin: 0;">üìã Contas (<span id="accounts-count">0</span>)</h2>
          <div class="btn-group" style="margin: 0;">
            <button class="btn btn-secondary" onclick="checkAccountsStatus()">üîÑ Verificar Status</button>
            <button class="btn btn-primary" onclick="loadChannels()">üì∫ Carregar Canais (Filtro HD)</button>
            <button class="btn btn-danger" onclick="forceLoadAllChannels()">‚ö†Ô∏è For√ßar Tudo (Diagn√≥stico)</button>
          </div>
        </div>
        <div id="accounts-list"></div>
      </div>

      <div class="card">
        <h2>‚òÅÔ∏è Cloudflare KV (Stremio)</h2>
        <input type="password" id="kv-token" placeholder="API Token">
        <input type="text" id="kv-account" placeholder="Account ID">
        <input type="text" id="kv-namespace" placeholder="Namespace ID">
        <div class="btn-group">
          <button class="btn btn-success" onclick="updateKV()">‚ö° Atualizar KV</button>
          <button class="btn btn-secondary" onclick="exportJSON()">üìÑ Exportar JSON</button>
          <button class="btn btn-secondary" onclick="exportM3U()">üì∫ Exportar M3U</button>
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #27272a;">
           <h3 style="font-size: 14px; margin: 0;">üóëÔ∏è Cache</h3>
           <button class="btn btn-danger" onclick="clearChannelsCache()">üóëÔ∏è Limpar Cache Agora</button>
        </div>
      </div>
    </div>

    <!-- CHANNELS TAB -->
    <div id="tab-channels" class="section">
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="üîç Buscar canais..." oninput="filterChannels()">
      </div>
      <div id="channels-grid" class="channels-grid"></div>
    </div>
  </div>

  <!-- PLAYER MODAL -->
  <div id="player-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="player-title">üì∫ Canal</h3>
        <div class="btn-group" style="margin: 0;">
          <button class="btn btn-secondary" onclick="copyPlayerUrl()">üìã Copiar URL</button>
          <button class="btn btn-danger" onclick="closePlayer()">‚úï Fechar</button>
        </div>
      </div>
      <div class="modal-body">
        <video id="player" controls></video>
        <div class="player-loading" id="player-loading">
          <div class="spinner"></div>
          <p style="margin-top: 15px; color: #71717a;">Carregando stream...</p>
        </div>
        <div class="player-error" id="player-error">
          <h4>‚ö†Ô∏è Erro ao Carregar Stream</h4>
          <p id="error-message">N√£o foi poss√≠vel reproduzir este canal.</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="retryPlayer()">üîÑ Tentar Novamente</button>
            <button class="btn btn-secondary" onclick="copyPlayerUrl()">üìã Copiar URL</button>
            <button class="btn btn-secondary" onclick="closePlayer()">‚úï Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === ESTADO GLOBAL ===
    let accounts = [];
    let channels = [];
    let currentPlayerUrl = '';
    let hlsInstance = null;

    // === INICIALIZA√á√ÉO ===
    window.addEventListener('DOMContentLoaded', () => {
      loadFromStorage();
      renderAccounts();
      renderChannels();
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePlayer(); });
    });

    function loadFromStorage() {
      const savedAccounts = localStorage.getItem('iptv_accounts');
      if (savedAccounts) accounts = JSON.parse(savedAccounts);
      
      const savedChannels = localStorage.getItem('iptv_channels');
      if (savedChannels) channels = JSON.parse(savedChannels);
      
      const savedKV = localStorage.getItem('iptv_kv_config');
      if (savedKV) {
        const kv = JSON.parse(savedKV);
        document.getElementById('kv-token').value = kv.token || '';
        document.getElementById('kv-account').value = kv.accountId || '';
        document.getElementById('kv-namespace').value = kv.namespaceId || '';
      }
    }

    function saveToStorage() {
      localStorage.setItem('iptv_accounts', JSON.stringify(accounts));
      localStorage.setItem('iptv_channels', JSON.stringify(channels));
      const kv = {
        token: document.getElementById('kv-token').value,
        accountId: document.getElementById('kv-account').value,
        namespaceId: document.getElementById('kv-namespaceId').value
      };
      localStorage.setItem('iptv_kv_config', JSON.stringify(kv));
    }

    // Limpar cache
    function clearChannelsCache() {
      channels = [];
      saveToStorage();
      renderChannels();
      notify('üóëÔ∏è Cache limpo.');
    }

    // === UI ===
    function notify(message) {
      const el = document.getElementById('notification');
      el.textContent = message;
      el.classList.add('active');
      setTimeout(() => el.classList.remove('active'), 3000);
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    // === IMPORT ACCOUNTS ===
    function importAccounts() {
      const text = document.getElementById('import-text').value.trim();
      if (!text) return notify('‚ö†Ô∏è Cole os logs primeiro');
      
      // Regex melhorado para evitar erros de parse
      const regex = /(https?:\/\/([^\/\s:]+)(?::(\d+))?\/get\.php\?username=([^&\s]+)&password=([^&\s]+)/gi;
      let match, found = 0;
      let newAccounts = [...accounts];
      
      while ((match = regex.exec(text)) !== null) {
        // Tratamento seguro de host
        let fullHost = match[1];
        let port = '80';
        if (match[2]) port = match[2].replace(':', '');
        const cleanHost = fullHost.replace(/:\d+$/, '');
        const user = match[3];
        const pass = match[4];
        const finalUrl = `${cleanHost}:${port}/get.php?username=${user}&password=${pass}`;
        
        if (!newAccounts.find(a => a.url === finalUrl)) {
          newAccounts.push({
            id: `${cleanHost}-${user}-${Date.now()}`,
            name: `${cleanHost.split('.')[0]}-${user.slice(0, 6)}`,
            url: finalUrl,
            status: 'checking'
          });
          found++;
        }
      }
      
      if (found > 0) {
        accounts = newAccounts;
        document.getElementById('import-text').value = '';
        saveToStorage();
        renderAccounts();
        clearChannelsCache(); // Limpeza ao importar para evitar dados mistos
        notify(`‚úÖ ${found} acessos importados`);
        checkAccountsStatus();
      } else {
        notify('‚ö†Ô∏è Nenhum acesso v√°lido encontrado');
      }
    }

    function removeAccount(index) {
      if (!confirm('Remover esta conta?')) return;
      accounts.splice(index, 1);
      clearChannelsCache();
      saveToStorage();
      renderAccounts();
      notify('‚úÖ Conta removida');
    }

    function renderAccounts() {
      const list = document.getElementById('accounts-list');
      document.getElementById('accounts-count').textContent = accounts.length;
      
      if (accounts.length === 0) {
        list.innerHTML = '<p style="text-align: center; padding: 40px; color: #71717a;">Nenhuma conta configurada</p>';
        return;
      }
      
      list.innerHTML = accounts.map((acc, i) => {
        const match = acc.url.match(/https?:\/\/([^:\/]+):([^@]+)@([^:\/]+)/);
        const host = match ? match[3] : '???';
        const statusClass = acc.status === 'online' ? 'status-online' : acc.status === 'checking' ? 'status-checking' : 'status-offline';
        
        return `
          <div class="account-item">
            <div class="account-info">
              <span class="status-dot ${statusClass}"></span>
              <span class="account-name">${acc.name}</span>
              <div class="account-host">${host}</div>
            </div>
            <div class="account-actions">
              <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="removeAccount(${i})">‚úï Remover</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // === CHECK STATUS ===
    async function checkAccountsStatus() {
      if (accounts.length === 0) return notify('‚ö†Ô∏è Adicione contas primeiro');
      
      accounts.forEach(acc => acc.status = 'checking');
      renderAccounts();
      notify('üîÑ Verificando status...');
      
      const checks = accounts.map(async (acc, i) => {
        const match = acc.url.match(/https?:\/\/([^:]+):([^@]+)@([^:\/]+):?(\d+)?/);
        if (!match) { accounts[i].status = 'offline'; return; }
        
        const [, user, pass, host, port = '80'] = match;
        // Tenta direto primeiro, sem proxy (mais r√°pido e evita bloqueios do proxy)
        const authUrl = `http://${host}:${port}/player_api.php?username=${user}&password=${pass}`;
        
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 10000); // Aumentado timeout para conex√µes lentas
          
          const res = await fetch(authUrl, { signal: controller.signal });
          clearTimeout(timeout);
          
          if (res.ok) {
            const data = await res.json();
            accounts[i].status = data.user_info?.auth ? 'online' : 'offline';
          } else {
            accounts[i].status = 'offline';
          }
        } catch {
          accounts[i].status = 'offline';
        }
      });
      
      await Promise.all(checks);
      saveToStorage();
      renderAccounts();
      notify('‚úÖ Verifica√ß√£o conclu√≠da');
    }

    // === LOAD CHANNELS (RECUPERA√á√ÉO) ===
    async function loadChannels() {
      if (accounts.length === 0) return notify('‚ö†Ô∏è Adicione contas primeiro');
      
      const activeAccounts = accounts.filter(a => a.status === 'online');
      if (activeAccounts.length === 0) return notify('‚ö†Ô∏è Nenhuma conta online. Verifique o status.');
      
      notify('üîÑ Carregando canais HD...');
      clearChannelsCache();
      channels = [];
      
      const keywords = ['PREMIERE', 'PREMIERE FC', 'PREMIERE CLUBES', 'AMAZON PRIME', 'PRIME VIDEO', 'ESPN', 'SPORTV', 'SPOR TV'];
      
      for (const account of activeAccounts) {
        console.log(`üì° Processando conta: ${account.name}`); // Log de diagn√≥stico
        
        try {
          const match = account.url.match(/https?:\/\/([^:]+):([^@]+)@([^:\/]+):?(\d+)?/);
          if (!match) continue;
          
          const [, user, pass, host, port = '80'] = match;
          const baseUrl = `http://${host}:${port}`;
          
          // 1. Auth
          const authRes = await fetch(`${baseUrl}/player_api.php?username=${user}&password=${pass}`);
          if (!authRes.ok) continue;
          const authData = await authRes.json();
          if (!authData.user_info?.auth) continue;
          
          // 2. Channels
          const channelsUrl = `${baseUrl}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
          const channelsRes = await fetch(channelsUrl);
          if (!channelsRes.ok) continue;
          
          const channelsData = await channelsRes.json();
          if (!Array.isArray(channelsData)) continue;
          
          console.log(`   üì∫ ${account.name}: Total encontrado: ${channelsData.length} canais (Bruto)`); // Log de diagn√≥stico
          
          let validCount = 0;
          
          for (const ch of channelsData) {
            const upper = ch.name.toUpperCase();
            const isTarget = keywords.some(kw => upper.includes(kw.toUpperCase()));
            if (!isTarget) continue;
            
            // Filtro HD/SD
            const isHD = /\b(HD|FHD|FULLHD|1080p)\b/i.test(upper); // Aceita HD, FHD, 1080p
            
            // Se n√£o for HD, ignora (√© SD). 
            if (!isHD) continue;
            
            const streamUrl = `http://${host}:${port}/live/${user}/${pass}/${ch.stream_id}.m3u8`;
            
            let category = 'OUTROS';
            if (upper.includes('PREMIERE')) category = 'PREMIERE';
            else if (upper.includes('AMAZON') || upper.includes('PRIME')) category = 'AMAZON PRIME';
            else if (upper.includes('ESPN')) category = 'ESPN';
            else if (upper.includes('SPORTV') || upper.includes('SPOR TV')) category = 'SPORTV';
            
            const channelId = `${account.id}-${ch.stream_id}`;
            
            channels.push({
              id: channelId,
              name: ch.name,
              url: streamUrl,
              account: account.name,
              category
            });
            validCount++;
          }
          
          console.log(`   ‚úÖ ${account.name}: ${validCount} canais HD encontrados.`);
        } catch (error) {
          console.error(`‚ùå Erro em ${account.name}:`, error);
          notify(`‚ùå ${account.name}: Erro ao carregar`);
        }
      }
      
      if (channels.length === 0) {
        notify('‚ö†Ô∏è Nenhum canal HD encontrado. Tente o bot√£o "For√ßar Tudo (Diagn√≥stico)".');
      } else {
        saveToStorage();
        renderChannels();
        switchTab('channels');
        notify(`‚úÖ ${channels.length} canais carregados!`);
      }
    }

    // === FORCE LOAD ALL (DIAGN√ìSTICO) ===
    async function forceLoadAllChannels() {
      if (accounts.length === 0) return notify('‚ö†Ô∏è Adicione contas primeiro');
      
      const activeAccounts = accounts.filter(a => a.status === 'online');
      if (activeAccounts.length === 0) return notify('‚ö†Ô∏è Nenhuma conta online.');
      
      notify('üö® Modo Diagn√≥stico: Buscando TODOS os canais (SD, FHD, 4K, etc)...');
      
      channels = []; // Limpa tudo para carregar tudo
  
      for (const account of activeAccounts) {
        try {
          console.log(`üì° Lendo BRUTO de ${account.name} (Diagn√≥stico)...`);
          
          const match = account.url.match(/https?:\/\/([^:]+):([^@]+)@([^:\/]+):?(\d+)?/);
          if (!match) continue;
          const [, user, pass, host, port = '80'] = match;
          const baseUrl = `http://${host}:${port}`;
          
          // Auth
          const authRes = await fetch(`${baseUrl}/player_api.php?username=${user}&password=${pass}`);
          if (!authRes.ok) continue;
          const authData = await authRes.json();
          if (!authData.user_info?.auth) continue;
          
          // Channels
          const channelsUrl = `${baseUrl}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
          const channelsRes = await fetch(channelsUrl);
          if (!channelsRes.ok) continue;
          
          const channelsData = await channelsRes.json();
          if (!Array.isArray(channelsData)) continue;
          
          console.log(`   üìä Total bruto na conta: ${channelsData.length} canais.`);
          
          let loadedCount = 0;
          
          for (const ch of channelsData) {
            // NOVA L√ìGICA DE FILTRAGEM MAIS PERMISSIVA
            // 1. Verifica se √© da God List (Palavras Chave)
            const upper = ch.name.toUpperCase();
            const isTarget = [
              'PREMIERE', 'PREMIERE FC', 'PREMIERE CLUBES',
              'AMAZON PRIME', 'PRIME VIDEO', 'AMAZON', 'PRIME SPORTS',
              'ESPN', 'ESPN 2', 'ESPN 3', 'ESPN BRASIL', 'ESPN4',
              'SPORTV', 'SPOR TV', 'SPORTV 2', 'SPORTV 3',
              'DAZN', 'HBO MAX', 'HBO MAX 1', 'HBO MAX 2'
            ].some(kw => upper.includes(kw));
            
            if (!isTarget) continue;
            
            // 2. Tenta garantir qualidade (Prioriza HD, mas inclui FHD/4K se for o foco forr qualidade total)
            // Removi restri√ß√£o estrita de 'SD' para garantir que voc√™ encontre algo
            // Nota: Alguns servidores colocam "PREMIERE 1" sem o "HD". Se for√ßar, vamos pegar.
            
            const streamUrl = `http://${host}:${port}/live/${user}/${pass}/${ch.stream_id}.m3u8`;
            
            let category = 'OUTROS';
            if (upper.includes('PREMIERE')) category = 'PREMIERE';
            else if (upper.includes('AMAZON') || upper.includes('PRIME')) category = 'AMAZON PRIME';
            else if (upper.includes('ESPN')) category = 'ESPN';
            else if (upper.includes('SPORTV') || upper.includes('SPOR TV')) category = 'SPORTV';
            else if (upper.includes('DAZN')) category = 'DAZN';
            else if (upper.includes('HBO MAX')) category = 'HBO MAX';
            else if (upper.includes('TNT')) category = 'TNT SPORTS';
            
            const channelId = `${account.id}-${ch.stream_id}`;
            
            channels.push({
              id: channelId,
              name: ch.name,
              url: streamUrl,
              account: account.name,
              category
            });
            loadedCount++;
          }
          
          console.log(`   ‚úÖ ${account.name}: ${loadedCount} canais encontrados.`);
        } catch (error) {
          console.error(`‚ùå Erro diagn√≥stico em ${account.name}:`, error);
        }
      }
      
      if (channels.length === 0) {
        notify('‚ö†Ô∏è Modo Diagn√≥stico tamb√©m n√£o encontrou canais. As contas podem estar offline ou expiradas.');
      } else {
        saveToStorage();
        renderChannels();
        switchTab('channels');
        notify(`‚ö° Diagn√≥stico: ${channels.length} canais carregados (Tudo). Se aparecerem nomes estranhos, as contas provavelmente mudaram.`);
      }
    }

    // === RENDER CHANNELS ===
    function renderChannels() {
      const grid = document.getElementById('channels-grid');
      document.getElementById('channel-count').textContent = channels.length;
      
      if (channels.length === 0) {
        grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #71717a; grid-column: 1/-1;">Nenhum canal carregado.</p>';
        return;
      }
      
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const filtered = channels.filter(ch => 
        !searchTerm || ch.name.toLowerCase().includes(searchTerm) || ch.category.toLowerCase().includes(searchTerm)
      );
      
      grid.innerHTML = filtered.map(ch => {
        // Limpeza a categoria
        const catClass = ch.category.replace(/\s+/g, '-').toLowerCase();
        const catEmoji = {
          'PREMIERE': '‚öΩ', 'AMAZON PRIME': 'üîµ', 'ESPN': 'üèÜ', 'SPORTV': 'üì∫', 'DAZN': 'üèàÔ∏è', 'HBO MAX': 'üé¨', 'TNT SPORTS': 'üõ°',
          'OUTROS': 'üì°'
        };
        
        return `
          <div class="channel-card">
            <div class="channel-category cat-${catClass}">${catEmoji[ch.category] || 'üì°'} ${ch.name}</div>
            <div class="channel-name">${ch.name}</div>
            <div class="channel-actions">
              <button class="btn btn-primary" onclick='playChannel(${JSON.stringify(ch.url)}, ${JSON.stringify(ch.name)})'>‚ñ∂ Play</button>
              <button class="btn btn-secondary" onclick='copyUrl(${JSON.stringify(ch.url)})'>üìã Copiar</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterChannels() {
      renderChannels();
    }

    // === PLAYER ===
    function playChannel(url, title) {
      currentPlayerUrl = url;
      document.getElementById('player-title').textContent = `üì∫ ${title}`;
      document.getElementById('player-modal').classList.add('active');
      document.getElementById('player-loading').classList.add('active');
      document.getElementById('player-error').classList.remove('active');
      
      const video = document.getElementById('player');
      video.style.display = block';
      
      if (hlsInstance) {
        hlsInstance.destroy();
        hlsInstance = null;
      }
      
      if (Hls.isSupported()) {
        // CORRE√á√ÉO DEFINITIVA: enableWorker (sem o "ker")
        hlsInstance = new Hls({
          enableWorker: true, 
          lowLatencyMode: false,
          backBufferLength: 90,
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
          maxBufferSize: 60 * 1000 * 1000,
          maxBufferHole: 0.5,
          manifestLoadingTimeOut: 20000,
          manifestLoadingMaxRetry: 3,
          levelLoadingTimeOut: 10000,
          fragLoadingTimeOut: 20000,
          fragLoadingMaxRetry: 6
        });
        
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
          document.getElementById('player-loading').classList.remove('active');
          video.play().catch(e => showPlayerError('Erro ao iniciar.'));
        });
        
        hlsInstance.on(Hls.Events.ERROR, (event, data) => {
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                showPlayerError('Erro de rede ou bloqueio.');
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                hlsInstance.recoverMediaError();
                break;
              default:
                showPlayerError('Erro fatal. Copie a URL.');
                break;
            }
          }
        });
        
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => {
          document.getElementById('player-loading').classList.remove('active');
          video.play().catch(e => showPlayerError('Erro ao iniciar: ' + e.message));
        });
        video.addEventListener('error', () => {
          showPlayerError('Erro ao carregar stream.');
        });
      } else {
        showPlayerError('Navegador incompat√≠vel.');
      }
    }

    function showPlayerError(message) {
      document.getElementById('player-loading').classList.remove('active');
      document.getElementById('player').style.display = 'none';
      document.getElementById('error-message').textContent = message;
      document.getElementById('player-error').classList.add('active');
    }

    function retryPlayer() {
      const title = document.getElementById('player-title').textContent.replace('üì∫ ', '');
      playChannel(currentPlayerUrl, title);
    }

    function copyPlayerUrl() {
      copyUrl(currentPlayerUrl);
    }

    function closePlayer() {
      if (hlsInstance) {
        hlsInstance.destroy();
        hlsInstance = null;
      }
      document.getElementById('player').pause();
      document.getElementById('player').src = '';
      document.getElementById('player-modal').classList.remove('active');
      currentPlayerUrl = '';
    }

    function copyUrl(url) {
      navigator.clipboard.writeText(url).then(() => {
        notify('‚úÖ URL copiada!');
      }).catch(() => {
        notify('‚ùå Erro ao copiar');
      });
    }

    // === CLOUDFLARE KV ===
    async function updateKV() {
      const token = document.getElementById('kv-token').value;
      const accountId = document.getElementById('kv-account').value;
      const namespaceId = document.getElementById('kv-namespace').value;
      
      if (!token || !accountId || !namespaceId) {
        return notify('‚ö†Ô∏è Configure as credenciais da Cloudflare primeiro');
      }
      
      if (channels.length === 0) {
        return notify('‚ö†Ô∏è Carregue os canais primeiro');
      }
      
      notify('üîÑ Atualizando Cloudflare KV...');
      
      const payload = {
        version: '1.0.0',
        updatedAt: new Date().toISOString(),
        totalChannels: channels.length,
        categories: ['premiere', 'amazon_prime', 'espn', 'sportv', 'dazn', 'hbo max', 'tnt sports', 'outros'],
        streams: {},
        accountsCount: accounts.filter(a => a.status === 'online').length
      };
      
      channels.forEach(ch => {
        const catKey = ch.category.toLowerCase().replace(/\s+/g, '_'); 
        if (!payload.streams[catKey]) payload.streams[catKey] = [];
        payload.streams[catKey].push({
          name: ch.name,
          url: ch.url,
          behaviorHints: { notWebReady: true }
        });
      });
      
      try {
        const kvUrl = `https://api.cloudflare.com/client/v4/accounts/${accountId}/storage/kv/namespaces/${namespaceId}/values/iptv_channels`;
        const res = await fetch(kvUrl, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (res.ok) {
          saveToStorage();
          notify('‚úÖ KV atualizado com sucesso!');
        } else {
          const error = await res.text();
          notify(`‚ùå Erro: ${error}`);
        }
      } catch (error) {
        notify(`‚ùå Erro: ${error.message}`);
      }
    }

    // === EXPORT ===
    function exportJSON() {
      if (channels.length === 0) return notify('‚ö†Ô∏è Carregue os canais primeiro');
      
      const data = {
        version: '1.0.0',
        exported: new Date().toISOString(),
        channels: channels
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `iptv-channels-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      notify('‚úÖ JSON exportado!');
    }

    function exportM3U() {
      if (channels.length === 0) return notify('‚ö†Ô∏è Carregue os canais primeiro');
      
      let m3u = '#EXTM3U\n\n';
      channels.forEach(ch => {
        m3u += `#EXTINF:-1 tvg-name="${ch.name}" group-title="${ch.category}",${ch.name}\n`;
        m3u += `${ch.url}\n\n`;
      });
      
      const blob = new Blob([m3u], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `iptv-playlist-${new Date().toISOString().split('T')[0]}.m3u`;
      a.click();
      URL.revokeObjectURL(url);
      notify('‚úÖ M3U exportado!');
    }
  </script>
</body>
</html>
