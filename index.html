<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>V15.3 FIX</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { background: #000; color: #0f0; font-family: monospace; margin: 0; padding: 5px; font-size: 13px; }
    
    .hidden { display: none; }
    .w-full { width: 100%; }
    .flex { display: flex; gap: 5px; }
    .mt-1 { margin-top: 5px; }
    
    /* INPUTS */
    input, textarea, select { background: #000; border: 1px solid #0f0; color: #0f0; padding: 8px; font-family: monospace; width: 100%; box-sizing: border-box; margin-bottom: 5px; }
    
    /* Input do Worker (Destaque) */
    #wurl { border-color: #ff00ff; color: #ff00ff; } 

    button { background: #002200; border: 1px solid #0f0; color: #0f0; padding: 10px; cursor: pointer; font-family: monospace; text-transform: uppercase; font-weight: bold; }
    button:active { background: #0f0; color: #000; }
    button.red { border-color: #f00; color: #f00; background: #220000; }
    button.blue { border-color: #00f; color: #00f; background: #000022; }
    button.purple { border-color: #ff00ff; color: #ff00ff; background: #220022; }

    /* LAYOUT */
    #tabs { display: flex; border-bottom: 1px solid #0f0; margin-bottom: 10px; }
    .tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; border: 1px solid #0f0; border-bottom: none; margin-bottom: -1px; background: #111; }
    .tab.on { background: #000; border-bottom: 1px solid #000; color: #fff; }
    
    .row { border-bottom: 1px dashed #333; padding: 5px; display: flex; justify-content: space-between; align-items: center; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 5px; }
    @media (min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
    
    .card { border: 1px solid #0f0; padding: 5px; display: flex; justify-content: space-between; align-items: center; }
    .card:active { background: #111; }

    #logs { background: #000; border: 1px solid #333; color: #888; height: 150px; overflow-y: auto; padding: 5px; font-size: 11px; white-space: pre-wrap; }

    #modal { position: fixed; inset: 0; background: #000; z-index: 99; display: none; flex-direction: column; }
    #modal.open { display: flex; }
    video { width: 100%; height: 100%; background: #000; }
    #ctrl { padding: 10px; display: flex; gap: 10px; background: #111; }
    #err { position: absolute; inset: 0; background: #000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
  </style>
</head>
<body>

<div id="tabs">
  <div class="tab on" onclick="V.go('cfg')">CFG</div>
  <div class="tab" onclick="V.go('lst')">LST (<span id="cnt">0</span>)</div>
  <div class="tab" onclick="V.go('log')">LOG</div>
</div>

<!-- CFG -->
<div id="cfg">
  <!-- WORKER PROXY CONFIG -->
  <div style="border: 1px dashed #ff00ff; padding: 5px; margin-bottom: 10px;">
    <label style="font-size: 10px; color: #ff00ff;">MEU WORKER PROXY (MELHOR OPÇÃO)</label>
    <input id="wurl" placeholder="https://seu-worker.workers.dev/proxy">
    <div style="font-size: 9px; color: #666; margin-top: 2px;">
      Preencha se upou o código do Proxy no Worker. Resolve bloqueio HTTP/HTTPS.
    </div>
  </div>

  <textarea id="in" rows="4" placeholder="Cole os logs SUZANOR (M3U+ link)..."></textarea>
  <div class="flex">
    <button class="w-full" onclick="V.imp()">1. IMPORTAR</button>
    <button onclick="V.chk()">2. CHECK</button>
  </div>
  <div id="acc" style="max-height: 120px; overflow-y: auto; border: 1px solid #222; margin-bottom: 5px;"></div>
  
  <label><input type="checkbox" id="force"> FORÇAR TUDO</label>
  <button onclick="V.load()">3. CARREGAR</button>

  <div class="mt-1" style="border-top: 1px solid #333; padding-top: 5px;">
    <div class="flex"><input id="t" placeholder="TOKEN"><input id="a" placeholder="ACC ID"></div>
    <div class="flex"><input id="n" placeholder="NS ID"><input id="k" placeholder="KEY"></div>
    <button class="purple w-full" onclick="V.sync()">4. SYNC STEALTH</button>
  </div>
</div>

<!-- LST -->
<div id="lst" class="hidden">
  <input id="s" placeholder="SEARCH..." onkeyup="V.rnd()">
  <div id="g" class="grid mt-1"></div>
</div>

<!-- LOG -->
<div id="log" class="hidden">
  <button onclick="document.getElementById('logs').innerHTML=''">CLR</button>
  <div id="logs"></div>
</div>

<!-- PLAYER -->
<div id="modal">
  <video id="v" controls playsinline></video>
  <div id="ctrl">
    <button style="flex:1" onclick="V.cp()">CP</button>
    <button class="red" style="flex:1" onclick="V.x()">X</button>
  </div>
  <div id="err">
    <h2 style="color:#f00">ERRO</h2>
    <button onclick="V.cast('vlc')">VLC</button>
    <button onclick="V.cast('wvc')">WVC</button>
    <button onclick="V.retry()">RET</button>
  </div>
</div>

<script>
const V = {
  d: { acc: [], ch: [] }, hls: null, cur: '',

  init() {
    const x = localStorage.getItem('v15_3_fix');
    if(x) this.d = JSON.parse(x);
    const c = JSON.parse(localStorage.getItem('v15_cf')||'{}');
    if(c.t) document.getElementById('t').value=c.t;
    if(c.a) document.getElementById('a').value=c.a;
    if(c.n) document.getElementById('n').value=c.n;
    if(c.k) document.getElementById('k').value=c.k;
    if(c.w) document.getElementById('wurl').value=c.w;
    this.rndAcc();
  },

  save() { 
    localStorage.setItem('v15_3_fix', JSON.stringify(this.d)); 
    localStorage.setItem('v15_cf', JSON.stringify({
      t: document.getElementById('t').value,
      a: document.getElementById('a').value,
      n: document.getElementById('n').value,
      k: document.getElementById('k').value,
      w: document.getElementById('wurl').value
    }));
  },

  log(m) { 
    const d = document.getElementById('logs'); 
    d.innerHTML += `[${new Date().toLocaleTimeString().split(' ')[0]}] ${m}\n`; 
    d.scrollTop = d.scrollHeight; 
  },

  // CORRIGIDO: IMPORTADOR SUZANOR
  imp() {
    const txt = document.getElementById('in').value;
    if(!txt.trim()) return alert('Cole os logs primeiro!');
    
    let c = 0;
    
    // 1. Regex Suzanor (M3U Link): http://host:port/get.php?username=X&password=Y
    const reM3U = /https?:\/\/([^\/:]+)(?::(\d+))?\/get\.php\?username=([^&]+)&password=([^&\s]+)/gi;
    let m;
    
    while ((m = reM3U.exec(txt)) !== null) {
      const host = m[1];
      const port = m[2] || '80';
      const user = m[3];
      const pass = m[4];
      
      // Monta URL no formato Xtream Codes: http://user:pass@host:port
      const url = `http://${user}:${pass}@${host}:${port}`;
      
      // Verifica duplicata
      if (!this.d.acc.find(x => x.url === url)) {
        this.d.acc.push({ 
          url: url, 
          h: host, 
          p: port, 
          u: user, 
          pw: pass, 
          s: '?' 
        });
        c++;
      }
    }
    
    if (c > 0) {
      document.getElementById('in').value = '';
      this.save();
      this.rndAcc();
      this.log(`+${c} CONTAS IMPORTADAS (Suzanor)`);
      this.chk(); // Auto check
    } else {
      alert('Nenhum acesso válido encontrado no formato M3U (Suzanor).');
    }
  },

  getProxy() {
    const myWorker = document.getElementById('wurl').value.trim();
    if (myWorker) {
      return (url) => myWorker + '?url=' + encodeURIComponent(url);
    }
    this.log(`USANDO PROXY PÚBLICO (ALLORIGINS)`);
    return (url) => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
  },

  go(p) {
    document.querySelectorAll('.tab').forEach(e=>e.classList.remove('on'));
    document.querySelectorAll('#cfg,#lst,#log').forEach(e=>e.classList.add('hidden'));
    document.getElementById(p==='cfg'?'cfg':(p==='lst'?'lst':'log')).classList.remove('hidden');
    document.querySelectorAll('.tab')[p==='cfg'?0:(p==='lst'?1:2)].classList.add('on');
    if(p==='lst') this.rnd();
  },

  async chk() {
    const proxyFn = this.getProxy();
    for(let a of this.d.acc) {
      a.s='..'; this.rndAcc();
      try {
        const u=`http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}`;
        const r=await fetch(proxyFn(u));
        const j=await r.json();
        a.s=(j.user_info?.auth)?'ON':'OFF';
      } catch(e) { a.s='OFF'; }
    }
    this.save(); this.rndAcc();
  },

  async load() {
    const v = this.d.acc.filter(a=>a.s==='ON');
    const t = v.length?v:this.d.acc;
    if(!t.length) return alert('SEM CONTAS');
    this.d.ch=[]; 
    const f = document.getElementById('force').checked;
    const k = ['PREMIERE','SPORTV','ESPN','DAZN','HBO','TNT'];
    const proxyFn = this.getProxy();

    for(const a of t) {
      try {
        const u=`http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}&action=get_live_streams`;
        const r=await fetch(proxyFn(u));
        const d=await r.json();
        if(Array.isArray(d)) d.forEach(x=>{
          const n=x.name.toUpperCase();
          if(f||k.some(kw=>n.includes(kw))) {
            this.d.ch.push({
              n:x.name, u:`http://${a.h}:${a.p}/live/${a.u}/${a.pw}/${x.stream_id}.m3u8`,
              q:n.includes('4K')?'4K':(n.includes('HD')?'HD':'SD')
            });
          }
        });
      } catch(e){}
    }
    this.save(); this.go('lst');
  },

  // --- SYNC ---
  async sync() {
    const T=document.getElementById('t').value, A=document.getElementById('a').value, N=document.getElementById('n').value, K=document.getElementById('k').value||'channels_data';
    if(!T||!A||!N) return alert('Falta CF');
    
    this.log('SYNC START...');
    const KW=['PREMIERE','SPORTV','ESPN','DAZN','HBO MAX','AMAZON PRIME','TNT SPORTS'];
    const MAX=90;
    const proxyFn = this.getProxy();
    
    // HELPERS
    const cln=n=>n.replace(/\s*(HD|SD|4K|UHD|FHD)\s*/gi,'').replace(/[^\s\-\.]+/g,'').replace(/\s+/g,' ').trim();
    const ok=n=>{
      const u=n.toUpperCase();
      return KW.some(k=>u.includes(k)) && u.includes('HD') && !/\b(SD|FHD|4K|UHD)\b/.test(u);
    };
    
    const cache=new Map();
    const get=async(e,u,p,h)=>{
      if(cache.has(h)) return cache.get(h);
      try {
        const r=await fetch(proxyFn(`${e}/player_api.php?username=${u}&password=${p}&action=get_live_streams`));
        const d=await r.json();
        if(Array.isArray(d)) { cache.set(h,d); return d; }
      } catch(e){}
      return null;
    };

    let all=[];
    for(const a of this.d.acc) {
      if(a.s!=='ON') continue;
      try {
        const au=`http://${a.h}:${a.p}/player_api.php?username=${a.u}&password=${a.pw}`;
        const ar=await fetch(proxyFn(au));
        const ad=await ar.json();
        if(!ad.user_info?.auth) continue;
        
        const lst=await get(`http://${a.h}:${a.p}`,a.u,a.pw,a.h);
        if(!lst) continue;

        const srv=ad.server_info.url, prt=ad.server_info.port;
        lst.forEach(c=>{
          if(!ok(c.name)) return;
          const l=c.name.toLowerCase(), cl=cln(l);
          if(!cl) return;
          
          let b='OUTRO';
          if(l.includes('premiere'))b='PREMIERE';
          else if(l.includes('sportv'))b='SPORTV';
          else if(l.includes('espn'))b='ESPN';
          else if(l.includes('dazn'))b='DAZN';
          else if(l.includes('hbo max'))b='HBO MAX';
          else if(l.includes('amazon'))b='PRIME';
          else if(l.includes('tnt'))b='TNT SPORTS';

          all.push({b,cl,n:c.name,u:`http://${srv}:${prt}/live/${a.u}/${a.pw}/${c.stream_id}.m3u8`,a:a.h});
        });
      } catch(e){}
    }

    const map=new Map();
    all.forEach(c=>{
      const k=`${c.b}::${c.cl}`;
      if(!map.has(k)) map.set(k,{b:c.b,cl:c.cl,s:[]});
      if(!map.get(k).s.some(x=>x.u===c.u)) map.get(k).s.push({n:c.name,u:c.u,a:c.a});
    });

    const order=['PREMIERE','SPORTV','ESPN','DAZN','HBO MAX','TNT SPORTS','PRIME','OUTRO'];
    const finC=[], finS={};
    let i=0, cnt={};
    const pre={'PREMIERE':'P','SPORTV':'S','ESPN':'E','DAZN':'Z','HBO MAX':'H','PRIME':'A','TNT SPORTS':'T','OUTRO':'X'};

    Array.from(map.values()).sort((a,b)=>order.indexOf(a.b)-order.indexOf(b.b)).forEach(d=>{
      if(finC.length>=MAX) return;
      cnt[d.b]=(cnt[d.b]||0)+1;
      const id=`ch_${i++}`, nm=`${pre[d.b]||'X'}${cnt[d.b]}`;
      finC.push({id,type:'tv',name:nm,poster:''});
      
      d.s.sort((x,y)=>(x.a.includes('Tourobox')?-1:(y.a.includes('Tourobox')?1:0)));
      if(d.s[0]) finS[id]=d.s[0].u;
      if(d.s[1]) finS[`${id}_b1`]=d.s[1].u;
    });

    try {
      const r=await fetch(`https://api.cloudflare.com/client/v4/accounts/${A}/storage/kv/namespaces/${N}/values/${K}`,{
        method:'PUT',headers:{'Authorization':`Bearer ${T}`,'Content-Type':'application/json'},
        body:JSON.stringify({channels:finC,streams:finS,t:Date.now()})
      });
      if(r.ok) { this.log(`OK: ${finC.length} CH UPADOS`); alert('SYNC OK'); }
      else { const e=await r.text(); this.log(`ERR: ${e}`); }
    } catch(e){ this.log(`NET ERR`); }
  },

  rndAcc() {
    document.getElementById('acc').innerHTML=this.d.acc.map((a,i)=>`
      <div class="row"><span class="dot" style="background:${a.s==='ON'?'#0f0':'#f00'}"></span>${a.h}<button onclick="V.del(${i})" style="color:red;border:none;background:none">X</button></div>
    `).join('')||'<div style="padding:5px;color:#444">VAZIO</div>';
  },

  rnd() {
    const q=document.getElementById('s').value.toUpperCase(), el=document.getElementById('g');
    document.getElementById('cnt').innerText=this.d.ch.length;
    el.innerHTML=this.d.ch.filter(c=>c.n.toUpperCase().includes(q)).map(c=>`
      <div class="card">
        <span>${c.n}</span>
        <button onclick="V.pl('${encodeURIComponent(c.u)}','${c.n.replace(/'/g,"\\'")}')">PLAY</button>
      </div>
    `).join('')||'<div style="padding:20px;text-align:center">VAZIO</div>';
  },

  pl(u,n){
    this.cur=decodeURIComponent(u);
    const v=document.getElementById('v'), m=document.getElementById('modal'), e=document.getElementById('err');
    m.classList.add('open'); e.style.display='none'; v.style.display='block';
    this.log(`PLAY: ${n}`);
    
    if(this.hls)this.hls.destroy();
    if(Hls.isSupported()){
      const proxyFn = this.getProxy();
      
      this.hls=new Hls({
        xhrSetup: (xhr, reqUrl) => {
           const target = typeof proxyFn === 'function' ? proxyFn(reqUrl) : reqUrl;
           xhr.open('GET', target, true);
        }
      });
      
      this.hls.loadSource(this.cur);
      this.hls.attachMedia(v);
      this.hls.on(Hls.Events.MANIFEST_PARSED,()=>v.play().catch(()=>{}));
      this.hls.on(Hls.Events.ERROR,()=>{
        v.pause(); v.style.display='none'; e.style.display='flex';
      });
    }else{ v.src=this.cur; v.play(); }
  },

  retry(){
    const v=document.getElementById('v'), e=document.getElementById('err');
    e.style.display='none'; v.style.display='block';
    this.initHls(v,e);
  },

  cast(t){
    const u=this.cur; if(!u)return;
    if(t==='vlc')window.location.href=`vlc://${u}`;
    if(t==='wvc')window.location.href=`intent://x#Intent;package=com.instantbits.cast.webvideo;S.url=${encodeURIComponent(u)};end`;
  },

  x(){ document.getElementById('modal').classList.remove('open'); document.getElementById('v').pause(); if(this.hls)this.hls.destroy(); },
  cp(){ if(this.cur){navigator.clipboard.writeText(this.cur); alert('CP');}},
  del(i){ this.d.acc.splice(i,1); this.save(); this.rndAcc(); },
  reset(){ if(confirm('RST?')){ this.d={acc:[], ch:[]}; this.save(); this.rndAcc(); this.rnd(); }}
};

window.onload=()=>V.init();
</script>
</body>
</html>
