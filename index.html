<!DOCTYPE html>
<html lang="pt-br" class="light-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilista</title>

    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <meta name="theme-color" content="#f1f5f9" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.core.min.js"></script>

    <style>
        /* CSS Incorporado - Vers√£o Final (com Download) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        :root, .light-theme {
            --font-family: 'Inter', system-ui, sans-serif;
            --color-text-primary: #0f172a; --color-text-secondary: #475569; --color-background: #f1f5f9;
            --color-card-bg: #ffffff; --color-border: #e2e8f0; --color-border-hover: #cbd5e1; --color-input-bg: #f8fafc;
            --accent-purple: #9333ea; --accent-pink: #db2777;
            --danger-color: #dc2626; --success-color: #16a34a; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .dark-theme {
            --color-text-primary: #f1f5f9; --color-text-secondary: #94a3b8; --color-background: #0f172a;
            --color-card-bg: #1e293b; --color-border: #334155; --color-border-hover: #475569; --color-input-bg: #334155;
        }
        @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        body { font-family: var(--font-family); color: var(--color-text-secondary); background-color: var(--color-background); background-image: linear-gradient(var(--color-border) 1px, transparent 1px), linear-gradient(to right, var(--color-border) 1px, var(--color-background) 1px); background-size: 25px 25px; transition: background-color 0.3s ease, color 0.3s ease; margin: 0; padding: 2rem; min-height: 100vh; box-sizing: border-box; }
        body.modal-open { overflow: hidden; }
        main { max-width: 900px; margin: auto; display: flex; flex-direction: column; gap: 1.5rem; }
        section { display: none; }
        section.visible { display: block; }
        h1, h2, h3, h4 { text-align: center; font-weight: 700; color: var(--color-text-primary); margin: 0; }
        h1 { font-size: 3rem; font-weight: 900; letter-spacing: -0.05em; }
        h2 { margin-bottom: 1.5rem; }
        .gradient-text { background-image: linear-gradient(to right, var(--accent-purple), var(--accent-pink)); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .site-description { text-align: center; color: var(--color-text-secondary); font-size: 1.1rem; margin: -1rem auto 0; max-width: 600px; line-height: 1.6; }
        .card { background-color: var(--color-card-bg); border-radius: 0.75rem; border: 1px solid var(--color-border); box-shadow: var(--shadow); padding: 2rem; contain: content; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; }
        .header-buttons { display: flex; gap: 0.5rem; }
        .btn { background-color: var(--color-card-bg); border: 1px solid var(--color-border); color: var(--color-text-primary); padding: 0.65rem 1.25rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center; will-change: transform; }
        .btn:hover:not(:disabled) { background-color: var(--color-input-bg); border-color: var(--color-border-hover); transform: translateY(-1px); }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn-primary { background-image: linear-gradient(to right, var(--accent-purple), var(--accent-pink)); color: white; border: none; box-shadow: var(--shadow); }
        .btn-primary:hover:not(:disabled) { color: white; transform: translateY(-2px); box-shadow: var(--shadow-md); filter: brightness(1.1); }
        .btn-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .btn-danger:hover:not(:disabled) { background: rgba(220, 38, 38, 0.05); }
        .btn-icon { width: 42px; height: 42px; padding: 0; border-radius: 50%; }
        .btn-icon svg { stroke: var(--color-text-secondary); transition: transform 0.2s ease; }
        .btn-icon:hover:not(:disabled) svg { stroke: var(--color-text-primary); transform: scale(1.1); }
        .btn .btn-icon-default { display: inline-flex; }
        .btn .btn-icon-success { display: none; }
        .btn.is-success .btn-icon-default { display: none; }
        .btn.is-success .btn-icon-success { display: inline-flex; }
        #upload-area { text-align: center; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 250px; cursor: pointer; border: 2px dashed var(--color-border); transition: all 0.3s ease; border-radius: 0.5rem; }
        #upload-area:hover { background-color: rgba(147, 51, 234, 0.03); }
        #upload-area.drag-over { border-color: var(--accent-purple); background-color: rgba(147, 51, 234, 0.05); transform: scale(1.02); box-shadow: 0 0 30px rgba(147, 51, 234, 0.3); }
        #upload-area.drag-over .default-text { display: none; }
        #upload-area:not(.drag-over) .drag-feedback { display: none; }
        .upload-icon { transition: transform 0.3s ease; }
        #upload-area.drag-over .upload-icon { transform: scale(1.2) translateY(-10px); }
        .upload-icon svg { width: 60px; height: 60px; stroke: var(--accent-purple); stroke-width: 1.5; margin-bottom: 1.5rem; }
        .upload-link { color: var(--accent-purple); font-weight: 600; text-decoration: underline; }
        .upload-hint { font-size: 0.9rem; }
        .loading-spinner { border: 4px solid rgba(147, 51, 234, 0.2); border-top-color: var(--accent-purple); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        #upload-content.hidden { visibility: hidden; opacity: 0; }
        .results-buttons { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem; }
        #generator-output { background: var(--color-input-bg); border: 1px solid var(--color-border); min-height: 100px; padding: 0.5rem 1.5rem; border-radius: 0.75rem; max-height: 400px; overflow-y: auto; color: var(--color-text-primary); }
        .result-category { margin-bottom: 1.5rem; }
        .result-category:first-child { margin-top: 1rem; }
        .result-category h4 { color: var(--color-text-primary); margin: 0 0 0.5rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid var(--color-border); text-align: left; }
        .result-list { list-style-type: none; padding-left: 0.5rem; margin: 0; font-family: monospace; font-size: 0.95rem; }
        .placeholder { color: var(--color-text-secondary); text-align: center; padding: 2rem 0; }
        .placeholder svg { width: 40px; height: 40px; stroke-width: 1.5; margin-bottom: 1rem; }
        .diagnostico-aviso { background: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--warning-color); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .unmapped-color-item { display: flex; align-items: center; justify-content: space-between; margin-top: 0.5rem; }
        .unmapped-color-info { display: flex; align-items: center; gap: 0.5rem; }
        .color-swatch-small { width: 16px; height: 16px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }
        .modal { display: flex; position: fixed; z-index: 20; left: 0; top: 0; width: 100%; height: 100%; align-items: center; justify-content: center; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal.open { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); max-width: 600px; width: 90%; max-height: 90vh; display: flex; flex-direction: column; contain: content; }
        .modal.open .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-subtitle { font-size: 1.1rem; text-align: left; margin-top: 1.5rem; margin-bottom: 1rem; }
        .close-btn { font-size: 2.5rem; font-weight: bold; color: var(--color-text-secondary); cursor: pointer; transition: color 0.3s; background: none; border: none; padding: 0; }
        .close-btn:hover { color: var(--accent-purple); }
        .modal-body { overflow-y: auto; padding: 1.5rem 0; margin: 0; }
        .modal-footer { display: flex; justify-content: flex-start; padding-top: 1rem; border-top: 1px solid var(--color-border); flex-shrink: 0; }
        hr { border: none; border-top: 1px solid var(--color-border); margin: 1.5rem 0; }
        .form-group { position: relative; display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .form-group label { flex-shrink: 0; width: 120px; text-align: right; font-weight: 500; }
        input[type="text"], input[type="search"] { background: var(--color-input-bg); color: var(--color-text-primary); border: 1px solid var(--color-border-hover); border-radius: 0.375rem; padding: 0.6rem; transition: all 0.2s ease; width: 100%; }
        input[type="text"]:focus, input[type="search"]:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: var(--accent-purple); box-shadow: 0 0 0 2px rgba(147, 51, 234, 0.2); }
        .settings-hint { color: var(--color-text-secondary); font-size: 0.9em; text-align: center; margin: -0.5rem 0 1.5rem 0; }
        .settings-hint.form-group-hint { text-align: left; margin: -0.5rem 0 1rem 136px; padding: 0; }
        .rule-item { transition: all 0.3s ease; }
        .rule-item.hidden { opacity: 0; height: 0; overflow: hidden; margin: 0; padding: 0; border: none; pointer-events: none; }
        .rule-item input[type="text"] { flex-grow: 1; }
        .rule-item .btn-delete { border-color: transparent; }
        .rule-item .btn-delete:hover { background-color: rgba(220, 38, 38, 0.05); }
        #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 30; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: #fff; box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 1rem; animation: toast-in 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; opacity: 0; transition: opacity 0.3s ease; }
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--danger-color); }
        .toast.info { background: #3b82f6; }
        .toast-action { background: rgba(0,0,0,0.2); border: none; color: #fff; padding: 0.3rem 0.6rem; border-radius: 0.25rem; cursor: pointer; font-weight: bold; }
        .dark-theme .theme-icon-light, .light-theme .theme-icon-dark { display: none; }
        .search-input { width: 100%; margin-bottom: 1rem; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: 0.5rem; background-color: var(--color-input-bg); color: var(--color-text-primary); }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        @media (max-width: 768px) { body { padding: 1rem; } main { gap: 1rem; } .header-actions { flex-direction: column; gap: 1.5rem; margin-bottom: 1rem; } h1 { font-size: 2.2rem; } .card { padding: 1.5rem; } .form-group { flex-direction: column; gap: 0.5rem !important; align-items: stretch !important; } .form-group label { text-align: left; width: auto; } .settings-hint.form-group-hint { text-align: left; padding-left: 0; margin-left: 0; } }
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }
        .color-display-wrapper { display: flex; align-items: center; gap: 0.75rem; background-color: var(--color-input-bg); border: 1px solid var(--color-border); padding: 0.5rem 1rem; border-radius: 0.375rem; flex-grow: 1; }
        .color-swatch-large { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); flex-shrink: 0; }
        #rule-color-display-hex { font-family: monospace; font-weight: bold; color: var(--color-text-primary); }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="live-feedback" class="sr-only" aria-live="polite"></div>

    <main>
        <header class="header-actions">
            <h1 class="gradient-text">Planilista</h1>
            <div class="header-buttons">
                <button class="btn btn-icon" id="theme-toggle-btn" title="Alterar Tema (T)" aria-label="Alterar Tema"><svg class="theme-icon-light" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><svg class="theme-icon-dark" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button>
                <button class="btn btn-icon" id="settings-btn" title="Configura√ß√µes (Ctrl+,)" aria-label="Abrir Configura√ß√µes" data-modal-trigger="settings-modal"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                <button class="btn btn-icon" id="clear-btn" title="Limpar Tudo" aria-label="Limpar resultados"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
            </div>
        </header>
        
        <p class="site-description">Transforme cores de planilhas em listas prontas em segundos.</p>
        
        <section id="upload-section" class="card visible" aria-labelledby="upload-section-title">
            <div id="upload-area">
                <div id="upload-content">
                    <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></div>
                    <div class="upload-text">
                        <h3 id="upload-section-title" class="default-text">Arraste um arquivo ou <span class="upload-link">clique para selecionar</span></h3>
                        <h3 class="drag-feedback">Pode soltar agora!</h3>
                    </div>
                    <p class="upload-hint">Formatos suportados: .xlsx, .xls, .csv</p>
                </div>
            </div>
            <input type="file" id="file-input" accept=".xlsx, .xls, .csv" class="sr-only">
        </section>
    
        <section id="sheet-selector-area" class="card" aria-labelledby="sheet-selector-title">
            <h3 id="sheet-selector-title">Selecione a Aba para Processar</h3>
            <select id="sheet-selector" class="btn" style="width:100%; justify-content: space-between; margin-top: 1rem;"></select>
        </section>
    
        <section id="results-area" class="card" aria-labelledby="results-title">
            <h2 id="results-title">Resultados</h2>
            <div id="generator-output"></div>
            <div id="diagnostico-container"></div>
            <div class="results-buttons">
                <!-- BOT√ÉO DE DOWNLOAD RESTAURADO -->
                <button class="btn" id="download-btn" disabled><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Baixar .txt</button>
                <button class="btn btn-primary" id="copy-btn" disabled>
                    <span class="btn-icon-default"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></span>
                    <span class="btn-icon-success"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg></span>
                    Copiar Lista
                </button>
            </div>
        </section>
    </main>
    
    <div id="settings-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
        <div class="modal-content card">
            <div class="modal-header">
                <h2 id="settings-modal-title">Configura√ß√µes</h2>
                <button class="close-btn" aria-label="Fechar modal" data-modal-close="settings-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="settings-hint">Suas altera√ß√µes s√£o salvas automaticamente.</p>
                <hr>
                <h3 class="modal-subtitle">Configura√ß√µes Gerais</h3>
                <div class="form-group">
                    <label for="target-column-input">Coluna Alvo:</label>
                    <input type="text" id="target-column-input" placeholder="Ex: F" pattern="[A-Z]+" title="Insira apenas letras mai√∫sculas (A, B, AA, etc.)">
                </div>
                <p class="settings-hint form-group-hint">Letra da coluna que cont√©m os n√∫meros a serem listados.</p>
                <hr>
                <h3 class="modal-subtitle">Regras de Cores</h3>
                <input type="search" id="rule-search-input" class="search-input" placeholder="Pesquisar por cor ou descri√ß√£o...">
                <div id="color-rules-list"></div>
                <hr>
                <div id="add-rule-form-container"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="reset-settings-btn">Resetar Configura√ß√µes</button>
            </div>
        </div>
    </div>
    
    <template id="rule-template"> <div class="form-group rule-item"> <div class="color-swatch-large"></div> <input type="text" placeholder="Descri√ß√£o da pend√™ncia" aria-label="Descri√ß√£o da regra de cor"> <button class="btn btn-icon btn-delete" aria-label="Excluir regra" title="Excluir regra"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button> </div> </template>
    <template id="add-rule-form-template">
        <div class="add-rule-form">
            <h3 class="modal-subtitle">Configurar Nova Cor</h3>
            <div class="form-group">
                <label for="rule-color-display">Cor:</label>
                <div class="color-display-wrapper">
                    <div id="rule-color-display-swatch" class="color-swatch-large"></div>
                    <span id="rule-color-display-hex"></span>
                </div>
            </div>
            <div class="form-group">
                <label for="new-desc-input">Descri√ß√£o:</label>
                <input type="text" id="new-desc-input" placeholder="Ex: Pendente Fiscal (Pressione Enter para salvar)">
            </div>
        </div>
    </template>

    <script type="module">
        'use strict';

        const state = { workbook: null, fileName: null, settings: { targetColumn: 'F', colorMap: {} }, rawResultsText: '', activeModalTrigger: null, lastSettingsBeforeReset: null, colorToAdd: null };
        const DOM = {
            doc: document.documentElement,
            uploadArea: document.getElementById('upload-area'),
            fileInput: document.getElementById('file-input'),
            sheetSelectorArea: document.getElementById('sheet-selector-area'),
            sheetSelector: document.getElementById('sheet-selector'),
            resultsArea: document.getElementById('results-area'),
            resultsTitle: document.getElementById('results-title'),
            generatorOutput: document.getElementById('generator-output'),
            diagnosticoContainer: document.getElementById('diagnostico-container'),
            clearBtn: document.getElementById('clear-btn'),
            copyBtn: document.getElementById('copy-btn'),
            downloadBtn: document.getElementById('download-btn'),
            settingsModal: document.getElementById('settings-modal'),
            targetColumnInput: document.getElementById('target-column-input'),
            colorRulesList: document.getElementById('color-rules-list'),
            ruleSearchInput: document.getElementById('rule-search-input'),
            resetSettingsBtn: document.getElementById('reset-settings-btn'),
            themeToggleBtn: document.getElementById('theme-toggle-btn'),
            liveFeedback: document.getElementById('live-feedback'),
            toastContainer: document.getElementById('toast-container'),
            addRuleFormContainer: document.getElementById('add-rule-form-container'),
            templates: { rule: document.getElementById('rule-template'), addRuleForm: document.getElementById('add-rule-form-template') },
        };

        const ui = {
            setLoading(isLoading) {
                const content = DOM.uploadArea.querySelector('#upload-content');
                if (content) content.classList.toggle('hidden', isLoading);
                const existingSpinner = DOM.uploadArea.querySelector('.loading-spinner');
                if (isLoading && !existingSpinner) {
                    const spinner = document.createElement('div');
                    spinner.className = 'loading-spinner';
                    DOM.uploadArea.appendChild(spinner);
                } else if (!isLoading && existingSpinner) {
                    existingSpinner.remove();
                }
            },
            renderResults({ fileName, html, raw, hasContent, skippedRows, unmappedColors }) {
                document.title = `${fileName.substring(0, fileName.lastIndexOf('.')) || fileName} - Planilista`;
                state.rawResultsText = raw;
                DOM.generatorOutput.innerHTML = html || this.getEmptyStateHTML('no_results');
                
                let diagnosticoHTML = '';
                if (unmappedColors.size > 0) {
                    let unmappedItemsHTML = '';
                    unmappedColors.forEach(color => {
                        unmappedItemsHTML += `<div class="unmapped-color-item"><div class="unmapped-color-info"><div class="color-swatch-small" style="background-color:${color}"></div><span>${color}</span></div><button class="btn btn-small" data-configure-color="${color}">Configurar</button></div>`;
                    });
                    diagnosticoHTML += `<div class="diagnostico-aviso"><strong>A√ß√£o necess√°ria:</strong> Encontramos ${unmappedColors.size} cor(es) n√£o configurada(s).<br>${unmappedItemsHTML}</div>`;
                }
                if (skippedRows.length > 0) diagnosticoHTML += `<div class="diagnostico-aviso"><strong>Aviso:</strong> ${skippedRows.length} linha(s) ignorada(s) por n√£o conterem n√∫meros na coluna alvo.</div>`;
                DOM.diagnosticoContainer.innerHTML = diagnosticoHTML;
                
                DOM.resultsArea.classList.add('visible');
                DOM.copyBtn.disabled = !hasContent;
                DOM.downloadBtn.disabled = !hasContent;
            },
            renderColorRules(colorMap) {
                const fragment = document.createDocumentFragment();
                if (Object.keys(colorMap).length === 0) {
                    DOM.colorRulesList.innerHTML = this.getEmptyStateHTML('no_rules');
                    return;
                }
                for (const color in colorMap) {
                    const ruleDiv = DOM.templates.rule.content.cloneNode(true).firstElementChild;
                    ruleDiv.dataset.color = color;
                    ruleDiv.querySelector('.color-swatch-large').style.backgroundColor = color;
                    ruleDiv.querySelector('input[type="text"]').value = colorMap[color];
                    fragment.appendChild(ruleDiv);
                }
                DOM.colorRulesList.innerHTML = '';
                DOM.colorRulesList.appendChild(fragment);
            },
            getEmptyStateHTML(stateKey) {
                const states = {
                    initial: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg><div><strong>Aguardando um ficheiro.</strong><p>Arraste uma planilha para come√ßar.</p></div>`,
                    no_results: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><div><strong>Tudo certo!</strong><p>Nenhuma pend√™ncia foi encontrada no seu ficheiro.</p></div>`,
                    no_rules: `<div style="padding:1rem; text-align:center;"><strong>Nenhuma regra configurada.</strong><p>Cores n√£o mapeadas aparecer√£o na tela principal para configura√ß√£o.</p></div>`
                };
                return `<div class="placeholder">${states[stateKey] || states.initial}</div>`;
            },
            resetUI() {
                Object.assign(state, { workbook: null, fileName: null, rawResultsText: '' });
                document.title = 'Planilista - Carregue uma planilha';
                DOM.fileInput.value = '';
                ['results-area', 'sheet-selector-area'].forEach(id => document.getElementById(id).classList.remove('visible'));
                DOM.generatorOutput.innerHTML = this.getEmptyStateHTML('initial');
                DOM.copyBtn.disabled = true;
                DOM.downloadBtn.disabled = true;
                DOM.diagnosticoContainer.innerHTML = '';
            },
            toggleModal(modal, open) {
                if (open) {
                    state.activeModalTrigger = document.activeElement;
                    modal.classList.add('open');
                    const firstFocusable = modal.querySelector('input, button');
                    if (firstFocusable) firstFocusable.focus();
                } else {
                    modal.classList.remove('open');
                    if (state.activeModalTrigger) state.activeModalTrigger.focus();
                    if (modal.id === 'settings-modal') { DOM.addRuleFormContainer.innerHTML = ''; state.colorToAdd = null; }
                }
                document.body.classList.toggle('modal-open', open);
            },
            showToast(message, type = 'info', options = {}) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                if (options.actionText) {
                    const btn = document.createElement('button');
                    btn.className = 'toast-action';
                    btn.textContent = options.actionText;
                    btn.onclick = () => { options.actionCallback(); toast.remove(); };
                    toast.appendChild(btn);
                }
                DOM.toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            },
            toggleTheme(theme) {
                const newTheme = theme || (DOM.doc.classList.contains('light-theme') ? 'dark' : 'light');
                DOM.doc.className = `${newTheme}-theme`;
                localStorage.setItem('planilistaTheme', newTheme);
            },
            filterRules: debounce((query) => {
                const normalizedQuery = query.toLowerCase().trim();
                DOM.colorRulesList.querySelectorAll('.rule-item').forEach(item => {
                    const desc = item.querySelector('input[type="text"]').value.toLowerCase();
                    const color = item.dataset.color.toLowerCase();
                    item.classList.toggle('hidden', !(desc.includes(normalizedQuery) || color.includes(normalizedQuery)));
                });
            }, 200),
            showSuccessOnButton(button) {
                button.classList.add('is-success');
                button.disabled = true;
                setTimeout(() => {
                    button.classList.remove('is-success');
                    button.disabled = false;
                }, 2000);
            },
            prepareAddRuleForm(color) {
                state.colorToAdd = color;
                const formTemplate = DOM.templates.addRuleForm.content.cloneNode(true);
                DOM.addRuleFormContainer.innerHTML = '';
                DOM.addRuleFormContainer.appendChild(formTemplate);
                document.getElementById('rule-color-display-swatch').style.backgroundColor = color;
                document.getElementById('rule-color-display-hex').textContent = color;
                const descInput = document.getElementById('new-desc-input');
                if (descInput) descInput.focus();
            },
        };
        
        const data = {
            loadSettings() {
                try {
                    const saved = localStorage.getItem('planilistaSettings');
                    state.settings = saved ? JSON.parse(saved) : { targetColumn: 'F', colorMap: {} };
                } catch {
                    state.settings = { targetColumn: 'F', colorMap: {} };
                }
                DOM.targetColumnInput.value = state.settings.targetColumn;
                ui.renderColorRules(state.settings.colorMap);
            },
            saveSettings(newSettings) {
                state.settings = newSettings;
                localStorage.setItem('planilistaSettings', JSON.stringify(state.settings));
            },
            processSheet(sheet, {colorMap, targetColumn}) {
                const colIndex = this.columnLetterToIndex(targetColumn);
                if (colIndex === -1) { ui.showToast(`Coluna "${targetColumn}" inv√°lida.`, 'error'); return null; }
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
                const results = {}, skippedRows = [], unmappedColors = new Set();
                for (let i = 1; i < json.length; i++) {
                    const lancamento = json[i][colIndex];
                    if (lancamento === undefined || lancamento === null || `${lancamento}`.trim() === '') continue;
                    if (isNaN(Number(lancamento))) { skippedRows.push(`Linha ${i + 1}`); continue; }
                    const cell = sheet[XLSX.utils.encode_cell({ c: colIndex, r: i })];
                    let corHex = cell?.s?.fgColor?.rgb ? '#' + cell.s.fgColor.rgb.slice(-6).toUpperCase() : null;
                    const desc = corHex ? colorMap[corHex] : undefined;
                    if (desc !== undefined) {
                        if (!results[desc]) results[desc] = [];
                        results[desc].push(lancamento);
                    } else if (corHex) {
                        unmappedColors.add(corHex);
                    }
                }
                return { ...this.formatResults(state.fileName, results), skippedRows, unmappedColors };
            },
            formatResults(fileName, resultsData) {
                const baseName = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
                let raw = `*${baseName.toUpperCase()}*\n\n`;
                let html = '';
                let hasContent = false;
                const categories = Object.keys(resultsData).filter(cat => cat.toUpperCase() !== 'OK');
                if (categories.length > 0) {
                    hasContent = true;
                    categories.forEach(category => {
                        const nums = resultsData[category];
                        raw += `${category}:\n${nums.join('\n')}\n\n`;
                        html += `<div class="result-category"><h4>${category}</h4><ul class="result-list">${nums.map(n => `<li>${n}</li>`).join('')}</ul></div>`;
                    });
                }
                return { html, raw: raw.trim(), hasContent };
            },
            columnLetterToIndex: (letter) => letter.toUpperCase().split('').reduce((acc, char) => acc * 26 + char.charCodeAt(0) - 64, 0) - 1,
        };
        
        const events = {
            async handleFileSelect(file) {
                if (!file) return;
                ui.resetUI();
                ui.setLoading(true);
                try {
                    const buffer = await file.arrayBuffer();
                    state.workbook = XLSX.read(buffer, { type: 'array', cellStyles: true });
                    state.fileName = file.name;
                    const sheetNames = state.workbook.SheetNames;
                    const fragment = document.createDocumentFragment();
                    sheetNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        fragment.appendChild(option);
                    });
                    DOM.sheetSelector.innerHTML = '';
                    DOM.sheetSelector.appendChild(fragment);
                    DOM.sheetSelectorArea.classList.toggle('visible', sheetNames.length > 1);
                    this.reprocessCurrentSheet();
                } catch (error) {
                    console.error("Erro ao processar ficheiro:", error);
                    ui.showToast(`Ocorreu um erro: ${error.message}`, 'error');
                } finally {
                    ui.setLoading(false);
                }
            },
            reprocessCurrentSheet: debounce(() => {
                if (!state.workbook) return;
                const sheet = state.workbook.Sheets[DOM.sheetSelector.value];
                const processedData = data.processSheet(sheet, state.settings);
                if (processedData) ui.renderResults({ fileName: state.fileName, ...processedData });
            }, 300),
            handleSettingsChange() {
                const newSettings = { ...state.settings, targetColumn: DOM.targetColumnInput.value.trim().toUpperCase() || 'F' };
                data.saveSettings(newSettings);
                this.reprocessCurrentSheet();
            },
            handleAddRule(desc) {
                if (!state.colorToAdd || !desc) return;
                if (state.settings.colorMap[state.colorToAdd]) { ui.showToast('Esta cor j√° est√° configurada.', 'error'); return; }
                const newColorMap = { ...state.settings.colorMap, [state.colorToAdd]: desc };
                data.saveSettings({ ...state.settings, colorMap: newColorMap });
                ui.renderColorRules(newColorMap);
                this.reprocessCurrentSheet();
                DOM.addRuleFormContainer.innerHTML = '';
                state.colorToAdd = null;
                ui.showToast('Nova regra adicionada.', 'success');
            },
            handleRuleListEvents(e) {
                const ruleItem = e.target.closest('.rule-item');
                if (!ruleItem) return;
                const color = ruleItem.dataset.color;
                const newColorMap = { ...state.settings.colorMap };
                if (e.target.closest('.btn-delete')) {
                    delete newColorMap[color];
                } else if (e.target.matches('input[type="text"]')) {
                    e.target.onchange = () => {
                        const newDesc = e.target.value.trim();
                        if (newDesc) {
                            newColorMap[color] = newDesc;
                            data.saveSettings({ ...state.settings, colorMap: newColorMap });
                            this.reprocessCurrentSheet();
                            ui.showToast(`Regra para ${color} atualizada.`, 'info');
                        } else { e.target.value = state.settings.colorMap[color]; }
                    };
                    return;
                }
                data.saveSettings({ ...state.settings, colorMap: newColorMap });
                ui.renderColorRules(newColorMap);
                this.reprocessCurrentSheet();
            },
            handleResetSettings() {
                state.lastSettingsBeforeReset = { ...state.settings };
                const newSettings = { targetColumn: 'F', colorMap: {} };
                data.saveSettings(newSettings);
                ui.renderColorRules(newSettings.colorMap);
                this.reprocessCurrentSheet();
                ui.showToast('Configura√ß√µes resetadas.', 'info', {
                    actionText: 'Desfazer',
                    actionCallback: () => {
                        data.saveSettings(state.lastSettingsBeforeReset);
                        ui.renderColorRules(state.lastSettingsBeforeReset.colorMap);
                        this.reprocessCurrentSheet();
                        ui.showToast('A√ß√£o desfeita.', 'success');
                    }
                });
            },
            handleCopyClick(e) {
                navigator.clipboard.writeText(state.rawResultsText).then(() => {
                    ui.showToast('Resultados copiados!', 'success');
                    ui.showSuccessOnButton(e.currentTarget);
                }).catch(() => ui.showToast('Falha ao copiar.', 'error'));
            },
            handleDownloadClick() {
                if (!state.rawResultsText) return;
                const blob = new Blob([state.rawResultsText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${(state.fileName || 'resultados').replace(/\.[^/.]+$/, "")}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                ui.showToast('Download iniciado.', 'info');
            },
            handleKeyboardShortcuts(e) {
                if (e.key === 'Escape') { const openModal = document.querySelector('.modal.open'); if (openModal) ui.toggleModal(openModal, false); }
                if ((e.ctrlKey || e.metaKey) && e.key === ',') { e.preventDefault(); ui.toggleModal(DOM.settingsModal, true); }
                if (e.key.toLowerCase() === 't' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') { e.preventDefault(); ui.toggleTheme(); }
            },
            init() {
                data.loadSettings();
                ui.resetUI();
                DOM.uploadArea.addEventListener('click', () => DOM.fileInput.click());
                DOM.fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files[0]));
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => DOM.uploadArea.addEventListener(eName, (e) => { e.preventDefault(); e.stopPropagation(); DOM.uploadArea.classList.toggle('drag-over', e.type === 'dragenter' || e.type === 'dragover'); if (e.type === 'drop') this.handleFileSelect(e.dataTransfer.files[0]); }));
                DOM.sheetSelector.addEventListener('change', this.reprocessCurrentSheet.bind(this));
                DOM.clearBtn.addEventListener('click', ui.resetUI.bind(ui));
                DOM.copyBtn.addEventListener('click', this.handleCopyClick);
                DOM.downloadBtn.addEventListener('click', this.handleDownloadClick);
                DOM.themeToggleBtn.addEventListener('click', () => ui.toggleTheme());
                DOM.targetColumnInput.addEventListener('input', debounce(this.handleSettingsChange.bind(this), 500));
                DOM.colorRulesList.addEventListener('click', this.handleRuleListEvents.bind(this));
                DOM.ruleSearchInput.addEventListener('input', (e) => ui.filterRules(e.target.value));
                DOM.resetSettingsBtn.addEventListener('click', this.handleResetSettings.bind(this));
                DOM.diagnosticoContainer.addEventListener('click', (e) => { if (e.target.dataset.configureColor) { const color = e.target.dataset.configureColor; ui.toggleModal(DOM.settingsModal, true); ui.prepareAddRuleForm(color); } });
                DOM.settingsModal.addEventListener('keydown', (e) => { if (e.target.id === 'new-desc-input' && e.key === 'Enter') { e.preventDefault(); this.handleAddRule(e.target.value.trim()); } });
                DOM.settingsModal.addEventListener('change', (e) => { if (e.target.id === 'new-desc-input') { this.handleAddRule(e.target.value.trim()); } });
                document.addEventListener('click', (e) => { if (e.target.closest('[data-modal-trigger]')) ui.toggleModal(document.getElementById(e.target.closest('[data-modal-trigger]').dataset.modalTrigger), true); if (e.target.closest('[data-modal-close]')) ui.toggleModal(document.getElementById(e.target.closest('[data-modal-close]').dataset.modalClose), false); });
                document.addEventListener('keydown', this.handleKeyboardShortcuts);
                const savedTheme = localStorage.getItem('planilistaTheme');
                if (savedTheme) ui.toggleTheme(savedTheme); else if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) ui.toggleTheme('dark');
            }
        };

        function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
        events.init();
    </script>
</body>
</html>
